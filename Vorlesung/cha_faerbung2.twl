\chapter{Färbung II}
\label{cha:faerbung2}


\pagebreak

\section{Rekursives Raytracing}
\label{sec:faerbungRayTracing}

\begin{description}
\item[Ziel:] einheitlicher Ansatz für:
  \begin{itemize}
  \item Sichtbarkeitsanalyse
  \item Schatten
  \item Reflexion, Spiegelungen
  \item Refraktion (Brechung)
  \end{itemize}
\end{description}

\begin{bemerkung}
  Schattenwurf, Spiegelungen und Lichtbrechung entstehen dadurch, dass
  das von der Lichtquelle kommende Licht das sichtbare Objekt $Oₖ$
  nicht direkt erreicht (Interaktion mit anderen Objekten).

  \begin{itemize}
  \item[⇒] Diese Effekte können nur mit einem
    \emph{nicht-lokalen Modell\index{nicht-lokales Modell}
      (Modell der Ordnung > 0\index{Modell der Ordnung > 0})} berücksichtigt werden.
  \end{itemize}
\end{bemerkung}


\subsection{Das Brechungsgesetz}

Einfallender und gebrochener Strahl liegen in derselben Ebene, und es
gilt
\[ \frac{\sin α_{\mathtxtit{I}}}{\sin α_{\mathtxtit{II}}} = \frac{η_{\mathtxtit{I}}}{η_{\mathtxtit{II}}}
  \qquad
  \white{\frac{\black{\text{\cmt{Brechungsindex von Medium I}}}}%
    {\black{\text{\cmt{Brechungsindex von Medium II}} \,\text.}}} \]

\begin{center}
  \scalebox{0.5}{\huge\input{fig_farbeRaytracingBrechungsgesetz}}%α
\end{center}

\begin{bemerkung}
  $η$ hängt \iA von der Wellenlänge ab.
\end{bemerkung}


\subsection{Der Raytracing-Ansatz nach Whitted}

\begin{description}
\item[Beobachtung:] Bei einem bestimmten Pixel sei der Punkt $\point{P}$ eines Objekts
  sichtbar.
  Das von $\point{P}$ ins Auge fallende Licht setzt sich zusammen
  aus
  \begin{itemize}
  \item dem bei $\point{P}$ einfallenden, ins Auge
    \emph{reflektierten} Licht und
  \item dem bei $\point{P}$ austretenden, in Augenrichtung
    \emph{gebrochenen} Licht
  \end{itemize}
  (jeweils direkt von den Lichtquellen und/oder bereits vorher –
  \evtl mehrfach – gespiegelt und/oder gebrochen).
  \personHidden{-80mm}{John Turner Whitted}{?, Durham, North Carolina}{}%
  {Elektroingenieur, Informatiker}%
  {person_Whitted}{}%
  {\urlpers{https://ece.ncsu.edu/honor/turner-whitted/}}%
  {}%Lizenz unklar

  \begin{center}
    \scalebox{0.5}{\huge\input{fig_farbeRaytracingWhitted}}
  \end{center}
\end{description}

\pagebreak

\minisec{Ansatz}

\begin{equation}
  \label{eq:whitted1}
  I\fk{\point{P}', \point{P}} =
  g\fk{\point{P}', \point{P}}
  · \mk{ε\fk{\point{P}', \point{P}}
    + ∫_{ℝ³} ρ\fk{\point{P}'', \point{P}', \point{P}} I\fk{\point{P}'', \point{P}'} \, d\point{P}''}
\end{equation}

\begin{tabular}{lp{21cm}}
  $I\fk{\point{P}', \point{P}}$: & Intensität des vom Punkt
  $\point{P}'$ nach $\point{P}$ gestrahlten Lichts \\
  $g\fk{\point{P}', \point{P}}$: & „Dämpfungsfaktor“ \par
  \qquad $= 0$, falls $\point{P}'$ von $\point{P}$ aus nicht sichtbar ist, \par
  \qquad proportional zu $\frac{1}{\norm[2]{\point{P}' - \point{P}}²}$ sonst \\
  $ε\fk{\point{P}', \point{P}}$: & Eigenemission von $\point{P}'$ nach $\point{P}$ \\
  $I\fk{\point{P}'', \point{P}'}$: & Intensität des bei $\point{P}'$ von einem Punkt $\point{P}''$
  einfallenden Lichts \\
  $ρ\fk{\point{P}'', \point{P}', \point{P}}$: &
  Reflexions-/Brechungskoeffizient für das von $\point{P}''$ bei
  $\point{P}'$ eintreffende und nach $\point{P}$ weitergegebene Licht
\end{tabular}

\begin{bemerkung}
  In dieser Formulierung werden Lichtquellen wie alle anderen Objekte
  behandelt.
\end{bemerkung}

\begin{description}
\item[Problem:] Die kontinuierliche Formulierung \eqref{eq:whitted1} ist für die
  praktische Rechnung nicht geeignet.
\end{description}

\pagebreak

\minisec{Erste Umformulierung}

\begin{equation}
  \label{eq:whitted2}
  I\fk{\vektor{r}, \point{P}} = g\fk{\point{P}', \point{P}}
  · \mk{ε\fk{\point{P}', \point{P}}
    + ∫ ρ\fk{\vektor{r}', \point{P}', -\vektor{r}} I\fk{\vektor{r}', \point{P}'} \, d\vektor{r}'}
\end{equation}

\begin{tabular}{lp{21cm}}
  $I\fk{\vektor{r}, \point{P}}$: & aus Richtung $\vektor{r}$ bei $\point{P}$ eintreffendes Licht \\
  $\point{P}'$: & der erste auf einem Objekt liegende Punkt, wenn man von $\point{P}$
  aus in Richtung $\vektor{r}$ geht \\
  $ρ\fk{\vektor{r}', \point{P}', -\vektor{r}}$: &
  Reflexions-/Brechungskoeffizient für das aus Richtung $\vektor{r}'$
  bei $\point{P}'$ eintreffende und in Richtung $-\vektor{r}$ weitergeleitete Licht \\
  $d\vektor{r}'$: & Integration über alle möglichen Richtungen
\end{tabular}

\minisec{Vereinfachungen}

\begin{itemize}
\item Berücksichtige in \eqref{eq:whitted2} nicht alle Richtungen
  $\vektor{r}'$ sondern nur die beiden durch Spiegel- und
  Brechungsgesetz gegebenen Richtungen:

  \begin{center}
    \scalebox{0.5}{\huge\input{fig_farbeRaytracingRichtungen}}%ₛ
  \end{center}

  (Aus Richtung $\vektor{r}ₛ$ \bzw $\vektor{r}_b$ einfallendes
  Licht wird in Richtung $-\vektor{r}$ gespiegelt \bzw gebrochen.)

  \pagebreak

\item Lichtquellen werden speziell behandelt.

  \begin{itemize}
  \item $ε ≡ 0$
    (Die betrachteten Objekte emittieren nicht selbst.)

  \item Für das \emph{direkt} von den Lichtquellen bei
    $\point{P}'$ eintreffende Licht wird eine Kombination von
    ambientem, diffusem und winkelabhängigem Anteil angesetzt.
  \end{itemize}
\end{itemize}

\begin{bemerkungen} \mbox{}
  \begin{enumerate}
  \item Lichtbrechung und Spiegelung an Objekten werden
    \emph{„zu perfekt“} nachgebildet. (In der Realität sind
    die Oberflächen nicht ganz glatt, \dH nach mehrfacher
    Spiegelung/Brechung „verschwimmt“ das Bild des Objekts.)

  \item Diffuse Reflexion wird nicht korrekt modelliert:

    \begin{center}
      \scalebox{0.5}{\huge\input{fig_farbeRaytracingProblemDiffus}}
    \end{center}
  \end{enumerate}
  \ReachedZoom{WS20/21}{09}{2021/01/07}
  \Reached{WS21/22}{09}{2021/12/09}
\end{bemerkungen}

\pagebreak

\vspace*{-26mm}
\begin{algorithmus} \mbox{}
  \begin{AlgListInline}
    Algorithmus Bilderzeugung mit rekursivem Raytracing

    für alle Pixel der Pixmap
    °°°$\point{P}$ := ein zum Pixel gehöriger Punkt in der Projektionsebene
    °°°$\vektor{r}$ := die zu diesem Punkt gehörige º„ºBlickrichtungº“º
    °°°Pixelwert := I($\vektor{r}$, $\point{P}$, $1$)
  \end{AlgListInline}
\end{algorithmus}

\enlargethispage{40mm}
\vspace*{-9mm}
\begin{algorithmus} \mbox{}
  \begin{AlgListInline}
    Algorithmus I($\vektor{r}$, $\point{P}$, $t$)
    // bestimmt, wie viel Licht aus Richtung $\vektor{r}$ beim Punkt $\point{P}$ einfällt; $t$ ist die Rekursionstiefe

    verfolge den von $\point{P}$ ausgehenden Strahl in Richtung $\vektor{r}$ ºbisº zum nächstgelegenen Schnittpunkt $\point{P}'$
    °°°°°mit einem Objekt $Oₖ$
    wenn es keinen solchen Schnittpunkt gibt
    °°°I($\vektor{r}$, $\point{P}$, $t$) := º„ºHintergrundº“º
    sonst
    °°°$I$ := $Iₐ · R_{k,a}$°°°°°// ambienter Anteil
    °°°// @\small\begin{tabular}[t]{ll} $Iₐ$: & Intensität des ambienten Lichts \\ $R_{k,a}$: & Reflexionskoeffizient für ambientes Licht \end{tabular}@
  \end{AlgListInline}

  \pagebreak

  \enlargethispage{10mm}
  \vspace*{-20mm}
  \begin{AlgListInline}
    °°°// Fortsetzung von „sonst“
    °°°// diffuser und winkelabhängiger „direkter“ Anteil
    °°°für alle Lichtquellen $Lₗ$
    °°°°°°wenn $\point{P}'$ von $Lₗ$ aus sichtbar ist
    °°°°°°°°°$I$ := $I + g\fk{Lₗ, \point{P}'} · Iₗ · \mk{\rk{\vektor{n}_{\point{P}'}ᵀ · \vektor{r}ₗ} · R_{k,d} + \rk{-\vektor{r}ᵀ · \vektor{s}ₗ}^{νₖ} · R_{k,w}}$
    °°°°°°°°°// @\raisebox{0pt}[0bp][78pt]{\small\begin{tabular}[t]{ll} $g\fk{Lₗ, \point{P}'}$: & Dämpfungsfaktor (abhängig von Entfernung, Medium und $λ$) \\ $Iₗ$: & Intensität von $Lₗ$ \\ $\vektor{n}_{\point{P}'}$: & Normale an $Oₖ$ in $\point{P}'$ \\ $\vektor{r}ₗ$: & Richtung von $\point{P}'$ nach $Lₗ$ \\ $R_{k,d}$: & Reflexionskoeffizient diffus \\ $-\vektor{r}$: & „Blickrichtung“ von $\point{P}'$ aus \\ $\vektor{s}ₗ$: & Spiegelrichtung für das von $Lₗ$ bei $\point{P}'$ eintreffende Licht \\ $R_{k,w}$: & Reflexionskoeffizient winkelabhängig \end{tabular}}@
    °°°wenn $Oₖ$ spiegelt und $t < t_{\max}$°°°°°// Spiegelung
    °°°°°°°°°// @\small\begin{tabular}[t]{ll} $t_{\max}$: & maximale Rekursionstiefe \end{tabular}@
    °°°°°°berechne die zu $\vektor{r}$ gehörige Spiegelrichtung $\vektor{r}ₛ$
    °°°°°°$I$ := $I + \mdef{\text{I}\fk{\vektor{r}ₛ, \point{P}', t + 1}} · R_{k,s}$°°°°°// Rekursion!
    °°°°°°°°°// @\small\begin{tabular}[t]{ll} $R_{k,s}$: & Spiegelungskoeffizient \end{tabular}@
    °°°wenn $Oₖ$ Licht bricht und $t < t_{\max}$°°°°°// Lichtbrechung
    °°°°°°berechne die zu $\vektor{r}$ gehörige Brechungsrichtung $\vektor{r}_b$
    °°°°°°$I$ := $I + \mdef{\text{I}\fk{\vektor{r}_b, \point{P}', t + 1}} · R_{k,b}$°°°°°// Rekursion!
    °°°°°°°°°// @\small\begin{tabular}[t]{ll} $R_{k,b}$: & Brechungskoeffizient \end{tabular}@
    °°°I($\vektor{r}$, $\point{P}$, $t$) := $I$
  \end{AlgListInline}
\end{algorithmus}

\pagebreak

\vspace*{-16mm}
\begin{bemerkungen} \mbox{}
  \begin{enumerate}
  \item Die Lichtstrahlen werden vom Betrachter aus bis zur
    Lichtquelle zurückverfolgt (entgegen der Ausbreitungsrichtung
    des Lichts).

  \item $t_{\max}$ gibt an, wie viele Interaktionen mit Objekten auf
    dem Weg von der Lichtquelle bis zum Betrachter berücksichtigt
    werden.

    Für $t_{\max} = 1$ ergibt sich im Wesentlichen das
    Beleuchtungsmodell von Phong (mit integrierter
    Schattenanalyse).

  \item Die Operationen

    \begin{quote}
      „\AlgInline!verfolge den von $\point{P}$ ausgehenden Strahl in Richtung $\vektor{r}$! …“
    \end{quote}

    und

    \begin{quote}
      „\AlgInline!wenn $\point{P}'$ von $Lₗ$ aus sichtbar ist!“
    \end{quote}

    sind sehr ähnlich.
    In beiden Fällen muss festgestellt werden, welches Objekt der
    Strahl zuerst trifft.

    Diese beiden Operationen verbrauchen den größten Teil der
    gesamten Rechenzeit.

    \begin{description}
    \item[„naiver Ansatz“:] Prüfe für alle Objekte $Oₖ$, ob sie vom Strahl
      getroffen werden, und bestimme \ggf den nächstgelegenen
      Schnittpunkt.
    \end{description}

    typische Größenordnungen:
    \begin{alignat*}{3}
      p &= \text{Anzahl der Pixel in der Pixmap} &&= 10⁶ \\
      n &= \text{Anzahl der Objekte} &&= 10⁵ \\
      m &= \text{Anzahl der Lichtquellen} &&= 3 \\
      t_{\max} &= \text{maximale Rekursionstiefe} &&= 5
    \end{alignat*}

    \begin{itemize}
    \item[⇒] Es müssen insgesamt bis zu
      \[ p · \underbrace{\rk{2^{t_{\max}} - 1} (m + 1)}_{\text{Aufspaltung des zum Pixel gehörenden Strahls}} \]
      Strahlen verfolgt werden.

    \item[⇒] bis zu
      \begin{align*}
        &p · \rk{2^{t_{\max}} - 1} (m + 1) · n \\
        &= 10⁶ · 124 · 10⁵ \\
        &≈ \mathbf{\mdef{10¹³}} \text{ \emph{Schnitttests!}}
      \end{align*}
      
    \item[⇒] Raytracing ist – naiv implementiert – nicht
      praktikabel.
    \end{itemize}
  \end{enumerate}
\end{bemerkungen}

\pagebreak

\pngpage{Bilder/uebung/rt-vorl-d1}

\pngpage{Bilder/uebung/rt-vorl-d2}

\pngpage{Bilder/uebung/rt-vorl-d3}

\pngpage{Bilder/uebung/rt-vorl-d4}

\pngpage{Bilder/uebung/rt-vorl-d5}

\pngpage{Bilder/uebung/rt-vorl-d6}

\pagebreak


\Reached{WS19/20}{10}{2019/12/12}
\subsection{Beschleunigung der Strahlverfolgung (I)}

\begin{description}
\item[Motivation:] Der zeitaufwändigste Teil des Raytracing ist die Bestimmung der
  Schnittpunkte der Strahlen mit den jeweils nächstgelegenen
  Objekten.

  \begin{itemize}
  \item[⇒] Versuche, die Anzahl der erforderlichen
    Schnitttests zu reduzieren
    (nicht für jeden Strahl alle Objekte testen).

  \item[⇒] \emph{Vorverarbeitung} notwendig
  \end{itemize}

\item[Ansatz:] Unterteile die Szene in Gebiete $Gᵢ$ und bestimme für jedes
  Gebiet die Menge $Lᵢ$ der (zumindest teilweise) in $Gᵢ$
  liegenden Objekte.

  \begin{itemize}
  \item[⇒] Ein Strahl kann Objekt $Oₖ$ nicht treffen,
    wenn $Oₖ$ nicht in den Listen $Lᵢ$ der vom Strahl
    berührten Gebiete $Gᵢ$ liegt.
  \end{itemize}

\item[Fragen:] \mbox{}

  \begin{itemize}
  \item Wie sind die $Gᵢ$ zu wählen?

  \item Wie bestimmt man die vom Strahl berührten $Gᵢ$?
  \end{itemize}
\end{description}

\pagebreak

\minisec{Zellraster-Unterteilung}

(\vgl Abschnitt~\ref{subsec:sichtbarkeitZellRaster})

\textbf{Vorverarbeitung:}

\begin{itemize}
\item Bestimme eine \emph{Bounding Box} $Q$ der Szene
  (achsenparalleler Quader, der alle Objekte $Oₖ$ –
  einschließlich Lichtquellen – enthält).

\item Unterteile $Q$ in $\mdef{rₓ × r_y × r_z}$
  Zellen $Q_{xyz}$ (Quader \emph{gleicher Größe}).

\item Bestimme für jedes Objekt $Oₖ$ die vom Objekt berührten
  Zellen (≙ \emph{3D Scan Conversion}) und trage
  $Oₖ$ in die entsprechenden Listen $L_{xyz}$ ein.
\end{itemize}

\textbf{eigentliche Strahlverfolgung:}

\begin{itemize}
\item Bestimme der Reihe nach die vom Strahl berührten Zellen
  (≙ \emph{inkrementelle 3D Scan Conversion}).

\item Führe für jede solche Zelle $Q_{xyz}$ Schnitttests mit den
  Objekten in $L_{xyz}$ durch.

  \cmt{\evtl nur für die Objekte, die nicht schon in anderen
    Zellen geprüft wurden}
\end{itemize}
\Reached{WS17/18}{10}{2017/12/14}

\pagebreak

\textbf{Beispiel (2D):}

\begin{center}
  \scalebox{0.5}{\huge\input{fig_farbeRaytracingZellen}}%₁₂₃₄₅
\end{center}

\pagebreak

\vspace*{-25mm}
\begin{Hide}
  \begin{center}
    \begin{tabular}{L|L|L|L}
      \multicolumn{1}{l|}{durchlaufene Zellen $Q_{xy}$} & L_{xy} &
      \multicolumn{1}{l|}{Schnitttests mit} & \multicolumn{1}{l}{Schnittpunkte} \\ \hline
      Q₂₁ & ∅ && \\
      Q₂₂ & O₁ & O₁ & \\
      Q₃₂ & O₃ & O₃ & \\
      Q₃₃ & O₂, O₃ & O₂ & \point{S}₂^{\mymagenta{*}} \\
      Q₃₄ & O₂, O₄ & O₄ & \point{S}₄^{\mymagenta{*}} \\
      Q₄₄ & O₂, O₃, O₄ &&
    \end{tabular}

    \mymagenta{${}^*$: bisher nächstgelegener Schnittpunkt}
  \end{center}
\end{Hide}
\Reached{WS14/15}{09}{2014/12/04}

\vspace*{-1mm}
\minisec{Octree-Unterteilung}
\index{Octree}

\begin{description}
\item[Idee:] Führe die Unterteilung \emph{adaptiv} durch, \dH unterteile dort
  feiner, wo sich viele (kleine) Objekte befinden.
\end{description}

\textbf{Vorverarbeitung:}

\begin{itemize}
\item Bestimme eine Bounding Box $Q_{∙∙∙}$ der Szene und setze
  $L_{∙∙∙} := \mk{\text{alle Objekte (einschl.\ Lichtquellen)}}$.

\item Solange es noch einen Quader $Q_{xyz}$ gibt, der „groß genug“
  ist und „zu viele“ Objekte enthält,

  \qquad zerlege $Q_{xyz}$ in \emph{acht} Quader $Q_{x' y' z'}$,

  \qquad bestimme für jeden dieser Teilquader die Menge
  $L_{x' y' z'} := \set{Oₖ ∈ L_{xyz}}{Oₖ \text{ trifft } Q_{x' y' z'}}$.
\end{itemize}

\textbf{eigentliche Strahlverfolgung:}

\begin{itemize}
\item ähnlich wie bei der Zellraster-Unterteilung (mit modifizierter
  Scan Conversion)
\end{itemize}

\textbf{Beispiel (2D):}

\begin{center}
  \scalebox{0.5}{\huge\input{fig_farbeRaytracingOctree}}%₁₂₃₄₅∙
\end{center}

\pagebreak

Kriterien für die Unterteilung in diesem Beispiel:
\begin{itemize}
\item „zu viele“ Objekte: mehr als eines
\item „groß genug“: in jeder Koordinatenrichtung in höchstens
  acht gleiche Teile zerlegen
\end{itemize}

zugehöriger \emph{Quadtree}\index{Quadtree}:

\begin{center}
  % \scalebox{0.39}{\huge\selectinput{fig_farbeRaytracingOctreeBaum}{leer}}%₁₂₃₄₅∙∅
  \scalebox{0.39}{\huge\input{fig_farbeRaytracingOctreeBaum}}%₁₂₃₄₅∙∅
\end{center}

\pagebreak

% \begin{Hide}
\begin{center}
  \begin{tabular}{L|L|L|L}
    \multicolumn{1}{l|}{durchlaufene Zellen $Q_{xy}$} & L_{xy} &
    \multicolumn{1}{l|}{Schnitttests mit} & \multicolumn{1}{l}{Schnittpunkte} \\ \hline
    Q_{01,00} & O₅ & O₅ & \\
    Q_{010,010} & O₁ & O₁ & \\
    Q_{010,011} & O₁ && \\
    Q_{011,011} & O₃ & O₃ & \\
    Q_{011,100} & O₃ && \\
    Q_{011,101} & O₂ & O₂ & \point{S}₂^{\mymagenta{*}} \\
    Q_{100,101} & O₃, O₄ & O₄ & \point{S}₄^{\mymagenta{*}} \\
    Q_{100,110} & O₂, O₄ &&
  \end{tabular}

  \mymagenta{${}^*$: bisher nächstgelegener Schnittpunkt}
\end{center}
% \end{Hide}

\begin{bemerkung}
  Die Strahlverfolgung springt \iA zwischen verschiedenen Niveaus des
  Octrees hin und her (Strahl läuft durch unterschiedlich große
  Zellen).
\end{bemerkung}

\pagebreak

\minisec{Median-Unterteilung}

\begin{description}
\item[Idee:] Versuche so zu unterteilen, dass die Teilgebiete (etwa) gleich
  viele Objekte treffen (aber kein „Normmaß“ mehr besitzen).

  Unterteile zuerst in $x$-Richtung, dann jede der beiden
  „Hälften“ (wenn nötig) in $y$-Richtung, dann die
  „Viertel“ in $z$-Richtung, dann wieder in $x$-Richtung, \usw
\end{description}

\textbf{Vorverarbeitung:}

\begin{itemize}
\item Bestimme eine Bounding Box $Q_{∙∙∙}$ der Szene und setze
  $L_{∙∙∙} := \mk{\text{alle Objekte (einschl.\ Lichtquellen)}}$.

\item Solange es noch einen Quader $Q_{xyz}$ gibt, der
  „groß genug“ ist und „zu viele“ Objekte enthält,

  \qquad zerlege $Q_{xyz}$ in der „nächsten“ Richtung in
  \emph{zwei} Quader $Q_{x' y' z'}$,

  \qquad bestimme für jeden dieser Teilquader die Menge
  $L_{x' y' z'}$.
\end{itemize}

\pagebreak

\vspace*{-19mm}
\textbf{Beispiel (2D):}

\vspace*{-14mm}
\begin{center}
  \scalebox{0.5}{\huge\input{fig_farbeRaytracingMedian}}%₁₂₃₄₅
\end{center}
\Reached{WS15/16}{09}{2016/01/07}

\begin{center}
  % \begin{Hide}
  \begin{tabular}{L|L|L|L}
    \multicolumn{1}{l|}{durchlaufene Zellen $Q_{xy}$} & L_{xy} &
    \multicolumn{1}{l|}{Schnitttests mit} & \multicolumn{1}{l}{Schnittpunkte} \\ \hline
    [-0,5; 3,0] × [-2,5; 0,5] & O₁ & O₁ & \\{}
    [-2,0; 3,0] × [0,5; 5,0] & O₂ & O₂ & \point{S}₂^{\mymagenta{*}} \\{}
    [3,0; 6,75] × [-1,0; 2,25] & O₃ & O₃ & \\{}
    [3,0; 5,5] × [2,25; 3,75] & O₂, O₄ & O₄ & \point{S}₄^{\mymagenta{*}}
  \end{tabular}

  \mymagenta{${}^*$: bisher nächstgelegener Schnittpunkt}
  % \end{Hide}
\end{center}

\pagebreak

zugehöriger \emph{BSP-Baum\index{BSP-Baum} (Binary Space
  Partitioning\index{Binary Space Partitioning})}:

% \begin{Hide}
\begin{center}
  % \resizebox{!}{94mm}{\huge\selectinput{fig_farbeRaytracingMedianBaum}{leer}}%₁₂₃₄₅≤
  \resizebox{!}{94mm}{\huge\input{fig_farbeRaytracingMedianBaum}}%₁₂₃₄₅≤
\end{center}
% \end{Hide}

\textbf{eigentliche Strahlverfolgung:}

\begin{itemize}
\item Lokalisiere den Ausgangspunkt des Strahls im BSP-Baum.

\item Bestimme, durch welche Fläche der Strahl die aktuelle Zelle
  verlässt, berechne einen Punkt $\widetilde{\point{P}}$
  „knapp jenseits“ dieser Fläche und lokalisiere
  $\widetilde{\point{P}}$ im BSP-Baum.

  \begin{itemize}
  \item[⇝] nächste vom Strahl durchlaufene Zelle
  \end{itemize}
\end{itemize}
\Reached{WS16/17}{11}{2017/01/12}

\minisec{Bemerkungen zu allen drei Unterteilungsstrategien}

\begin{itemize}
\item Dass ein Objekt mehrfach gegenüber demselben Strahl getestet
  wird (da es zu mehreren $Lᵢ$ gehört), lässt sich
  beispielsweise so verhindern:
  \begin{itemize}
  \item Ordne jedem untersuchten Strahl eine eindeutige
    (\zB fortlaufende) Nummer zu.
  \item Trage nach dem Schnitttest „Objekt $Oₖ$ – Strahl $j$“ die Nummer $j$ bei Objekt $Oₖ$ ein.
  \item Prüfe vor jedem Test „$Oₖ$ – $j$“, ob $Oₖ$
    bereits mit „$j$“ markiert ist.
  \end{itemize}

\item Die Schnitttests dürfen nicht abgebrochen werden, sobald der
  erste Schnittpunkt gefunden ist.
  Man muss bis zu der Zelle laufen, die den (unter den bereits
  bestimmten) nächstgelegenen Schnittpunkt enthält, und deren
  Objekte noch prüfen.

\item In der Vorverarbeitung kann man $Oₖ$ auch in alle Zellen
  aufnehmen, die von der \emph{Bounding Box} von $Oₖ$ getroffen
  werden (nicht unbedingt vom Objekt).

  \begin{itemize}
  \item[⇒] Vorverarbeitung \iA wesentlich einfacher,

    dafür später mehr überflüssige Schnitttests
  \end{itemize}
\end{itemize}

\pagebreak

\minisec{Vergleich der Unterteilungsstrategien}

\textbf{Zellraster:}

\begin{itemize}
\item[\Good] Die Listen $L_{xyz}$ können sehr effizient bestimmt
  werden.

\item[\Good] Die vom Strahl durchlaufenen Zellen können sehr einfach
  (und schnell) generiert und zugegriffen werden.

\item[\Bad] benötigt meist wesentlich mehr Zellen als die adaptiven
  Strategien
  \begin{itemize}
  \item Speicherplatz
  \item Bei der Strahlverfolgung müssen viele Zellen durchlaufen
    werden.
  \end{itemize}

\item[\Bad] Die $L_{xyz}$ können noch sehr umfangreich sein.

\item[⇒] geeignet für Szenen mit relativ kleinen, etwa
  gleichmäßig verteilten Objekten
\end{itemize}

\textbf{Octree:}

\begin{itemize}
\item[\Good] Vorverarbeitung und Strahlverfolgung relativ einfach

\item[\Good] moderate Anzahl von Zellen und einigermaßen
  ausgeglichene Verteilung der Objekte auf die Zellen

\item[\Bad] Der Octree kann sehr unbalanciert werden.
  \begin{itemize}
  \item[⇒] Zellengenerierung bei Strahlverfolgung wird
    langsamer
  \end{itemize}

\item[⇒] universell verwendbar, aber nicht immer optimal
\end{itemize}

\textbf{Median-Unterteilung:}

\begin{itemize}
\item[\Good] liefert oft gut balancierte Bäume mit wenigen Zellen

\item[\Bad] Vorverarbeitung und Strahlverfolgung werden komplexer

  (Wo muss der Quader unterteilt werden?)

\item[⇒] geeignet für Szenen mit „Ballungen“ kleiner
  Objekte
\end{itemize}
\Reached{WS18/19}{10}{2018/12/20}


\subsection{Beschleunigung der Strahlverfolgung (II)}

\begin{description}
\item[Beobachtung:] Die meisten der zu verfolgenden Strahlen gehen von wenigen festen
  Punkten (den $m$ \emph{Lichtquellen}) aus.

  \begin{itemize}
  \item[⇒] Versuche, die Tests „liegt auf dem Strahl
    von $Lₗ$ nach $\point{P}'$ ein anderes Objekt?“
    möglichst effizient zu machen.

  \item[⇒] Sammle in einer \emph{Vorverarbeitung} Information
    über die Lage der Objekte \bzgl der Lichtquellen.
  \end{itemize}

  \pagebreak

\item[Ansatz:]
  \emph{Lichtpuffer}\index{Lichtpuffer bei Raytracing}\index{Raytracing!Lichtpuffer}

  \begin{center}
    \scalebox{0.475}{\huge\input{fig_farbeRaytracingLichtpuffer}}%ₗ₁₂₃₄₅₆₇₈₉
  \end{center}
\end{description}

\minisec{Vorverarbeitung}

\begin{AlgListInline}
  für jede Lichtquelle $Lₗ$
  °°°lege einen Würfel um $Lₗ$ und unterteile dessen Seitenflächen in Zellen $Z_{l,i}$
  °°°bestimme für jede Zelle $Z_{l,i}$, welche Objekte (teilweise) in das durch $Lₗ$ und $Z_{l,i}$ definierte
  °°°°°°°°Volumen fallen, und speichere diese in einer Liste $L_{l,i}$
  °°°°°°°°(soweit möglich, bereits nach der Entfernung von $Lₗ$ geordnet)
  °°°/* praktische Realisierung: Führe für jedes Objekt $Oₖ$ Projektion auf den Würfel und Scan
  °°°°°°Conversion bzgl. der „Zellen-Pixmaps“ durch */
\end{AlgListInline}

\minisec{Eigentliche Strahlverfolgung}

\begin{AlgListInline}
  projiziere $\point{P}'$ auf den Würfel und bestimme die Zelle $Z_{l,i}$, in welche der Punkt fällt
  für alle Objekte $Oₖ$ in $L_{l,i}$
  °°°prüfe, ob der Strahl das Objekt zwischen $Lₗ$ und $\point{P}'$ schneidet
  °°°/* Wenn dies der Fall und $Oₖ$ undurchsichtig ist, dann können die Schnitttests abgebrochen
  °°°°°°werden */
\end{AlgListInline}

\pagebreak

\begin{description}
\item[Beobachtung:] \mbox{}

  \begin{center}
    \scalebox{0.6}{\LARGE\input{fig_farbeRaytracingAdaptiv1}}
  \end{center}

  \pagebreak

  Die wahrgenommene Intensität kann sich beispielsweise
  zusammensetzen aus:

  \begin{center}
    \scalebox{0.45}{\huge\input{fig_farbeRaytracingAdaptiv2}}
  \end{center}

  \begin{itemize}
  \item[⇒] $I_{BSS}$ geht nur mit dem Faktor
    $0,1 · 0,3 · 0,2 = 0,006$ in $I$ ein.

  \item[⇒] $I_{BSS}$ kann vernachlässigt werden, \emph{wenn}
    die Gesamtintensität $I$ „nicht zu klein“ ist.
  \end{itemize}

\item[Ansatz:] \emph{adaptive Tiefenkontrolle}%
  \index{adaptive Tiefenkontrolle bei Raytracing}\index{Raytracing!adaptive Tiefenkontrolle}

  \begin{itemize}
  \item Führe bei jedem rekursiven Aufruf der Strahlverfolgung
    zwei zusätzliche Parameter mit:

    \begin{itemize}
    \item den Faktor $f$, mit dem die Intensität des gerade
      verfolgten Strahls in die Gesamtintensität $I$
      eingeht

    \item die bisher akkumulierte Gesamtintensität $I$
    \end{itemize}

  \item Wenn $f ≪ I$, dann muss der Strahl nicht verfolgt
    werden.
  \end{itemize}
\end{description}

\begin{bemerkungen} \mbox{}
  \begin{enumerate}
  \item Um $I$ möglichst schnell wachsen zu lassen, sollte man die
    „Beiträge“ in geeigneter Reihenfolge betrachten:

    \begin{itemize}
    \item zuerst ambienter Anteil

      (benötigt keine Strahlverfolgung)

    \item dann Beiträge direkt von den Lichtquellen

      (Strahlverfolgung besonders effizient und rekursionsfrei)

    \item dann gespiegelter oder gebrochener Anteil (je nachdem,
      welcher der Koeffizienten $R_S$ oder $R_B$ größer
      ist)
    \end{itemize}

  \item Die „effektiv“ zu verfolgende Tiefe für ein
    einigermaßen realistisches Bild liegt bei etwa
    $t_{\mathtxtrm{eff}}$ ≈ 1,7 – 2,0
    (weitgehend unabhängig von $t_{\max}$).

    Enthält die Szene sehr viele stark spiegelnde und/oder
    brechende Objekte (\zB Glas), so kann $t_{\mathtxtrm{eff}}$ auch
    deutlich größer sein.
  \end{enumerate}
\end{bemerkungen}

\pagebreak

\begin{description}
\item[Beobachtung:] Wenn die „effektive“ Tiefe klein ist, geht ein großer Teil
  aller zu verfolgenden Strahlen vom Augenpunkt aus.

  \begin{itemize}
  \item[⇒] Versuche, die zuerst getroffenen Objekte
    möglichst effizient zu bestimmen.
  \end{itemize}

\item[Idee:] Strahlverfolgung vom Auge aus entspricht
  \emph{Visible Surface Ray Tracing}

  verwende statt dessen \emph{$\mathbf{z}$-Puffer}-Ansatz zur Bestimmung der
  sichtbaren (= zuerst erreichten) Objekte
\end{description}

\minisec{Vorverarbeitung}

\begin{AlgListInline}
  bestimme mit einem modifizierten $z$-Puffer-ºAlgorithmusº die Entfernung $z_{i,j}$ des bei jedem Pixel $(i, j)$
  °°°°°sichtbaren Objekts $O_{k_{i,j}}$
  // Die $k_{i,j}$ werden im sog. @\emph{Objektpuffer}@ gespeichert.
\end{AlgListInline}%
\index{Objektpuffer bei Raytracing}\index{Raytracing!Objektpuffer}

\minisec{Eigentliche Bilderzeugung}

\begin{AlgListInline}
  für jedes Pixel $(i, j)$
  °°°wenn $k_{i,j}$ = º„ºHintergrundº“º
  °°°°°°färbe das Pixel mit der Hintergrundfarbe
  °°°sonst
  °°°°°°bestimme den Schnittpunkt $\point{P}'$ des º„ºSehstrahlsº“º mit $O_{k_{i,j}}$
  °°°°°°färbe Pixel $(i, j)$ gemäß der von $\point{P}'$ einfallenden Intensität
  °°°°°°// ≙ Raytracing ohne die erste Strahlverfolgung
\end{AlgListInline}


\subsection{Selektives Raytracing}

\begin{description}
\item[Motivation:] Bei „nicht allzu künstlichen“ Szenen werden die
  durch Raytracing simulierten Effekte (Spiegelungen, \usw) nur an
  wenigen Stellen des Bildes sichtbar sein.

  \begin{itemize}
  \item[⇒] Versuche, den Aufwand für Raytracing an den
    „harmlosen“ Stellen des Bildes zu sparen.
  \end{itemize}

\item[Ansatz:] \mbox{}

  \begin{itemize}
  \item Erzeuge zunächst mit einem „Standard-Verfahren“
    (\zB $z$-Puffer-Algorithmus mit Phong-Shading) ein
    \emph{„rohes Bild“}.

    Führe dabei einen \emph{Objektpuffer} mit.

  \item \emph{„Nachbesserung“}:


    \begin{AlgListInline}
      für alle Pixel $(i, j)$
      °°°wenn das beim Pixel $(i, j)$ sichtbare Objekt $O_{k_{i,j}}$ spiegelt, durchsichtig ist o.@\,@ä.
      °°°°°°berechne die Färbung des Pixels mit Raytracing
    \end{AlgListInline}
  \end{itemize}
\end{description}

\pagebreak


\subsection{Bemerkungen}

\begin{itemize}
\item Trotz aller Optimierungen sind immer sehr viele Schnitttests
  notwendig – typisch: $𝒪\fk{10⁸}$

  \begin{itemize}
  \item[⇒] durch geeignete \emph{Vorverarbeitung der Objekte}
    diese Schnitttests (vor allem die erfolglosen!) möglichst
    schnell machen:

    \begin{itemize}
    \item Bounding Box, …
    \end{itemize}
  \end{itemize}

\item Die lokale Intensitätsberechnung kann leicht erweitert werden:

  \begin{itemize}
  \item Textur

  \item bessere Simulation der diffusen/winkelabhängigen
    Reflexion
    (Mikrofacetten-Modell, …)

  \item …
  \end{itemize}
\end{itemize}
\Reached{WS17/18}{11}{2017/12/21}
\ReachedZoom{WS20/21}{10}{2021/01/14}
\Reached{WS21/22}{10}{2021/12/16}

\pagebreak


\section{Radiosity-Verfahren}

\vspace*{-3mm}
(nach Goral/Torrance/Greenberg/Battaile 1984)

\begin{description}
\item[Ziel:] möglichst gute Nachbildung der Effekte (mehrmaliger) diffuser Reflexion
\end{description}
\personHidden{-5mm}{Cindy M.~Goral}{}{}{}{person_Goral}{}%
{\urlpers{https://www.linkedin.com/in/goral}}{}%

\personHidden{-15mm}{Kenneth E.~Torrance}{}{2010}{}{person_Torrance}{}%
{\urlpers{http://www.legacy.com/obituaries/theithacajournal/obituary.aspx?n=kenneth-e-torrance&pid=139745916}}%
{}%

\personHidden{-25mm}{Donald Peter Greenberg}%
{1934}{}{}%
{person_Greenberg}{}{\urlpers{https://aap.cornell.edu/people/donald-greenberg}}{}%

\personHidden{-35mm}{Bennett Battaile}{}{}{}%
{person_Battaile}{}%
{\urlpers{http://pnca.edu/faculty/meet/bbattaile}}{}%

\pagebreak

\begin{beispiele} \mbox{}
  \begin{enumerate}
  \item \emph{„Farbverschiebung“}\index{Farbverschiebung durch diffuse Reflexion}%
    \index{diffuse Reflexion!Farbverschiebung}

    \begin{center}
      \scalebox{0.5}{\huge\input{fig_farbeRadiosityFarbverschiebung}}
    \end{center}

    \begin{itemize}
    \item[⇒] Alle Objekte im Raum erhalten einen „Rotstich“.
    \end{itemize}

  \item \emph{„Colour Bleeding“}\index{Colour Bleeding bei diffuser Reflexion}%
    \index{diffuse Reflexion!Colour Bleeding}

    \begin{center}
      \scalebox{0.5}{\huge\input{fig_farbeRadiosityColourBleeding}}
    \end{center}

    \begin{itemize}
    \item[⇒] rote Farbe „läuft“ auch auf die weiße Fläche über
    \end{itemize}
  \end{enumerate}
\end{beispiele}

\pagebreak

\begin{description}
\item[Ansatz:] (Diffuse) Reflexion ist ein \emph{Energie}austausch zwischen den
  Objekten.

  \begin{itemize}
  \item[⇒] Übertrage ein Modell für den Wärmeaustausch
    auf den Austausch von Licht.
  \end{itemize}

\item[vereinfachende Annahmen:] \mbox{}

  \begin{itemize}
  \item Die Szene bildet ein \emph{geschlossenes System im Gleichgewicht}, \dH:

    \begin{itemize}
    \item Die gesamte von einem Objekt abgestrahlte
      (emittierte oder reflektierte) Energie wird von den
      Objekten der Szene absorbiert oder weiter reflektiert
      (kein Energietransport „nach außen“).

    \item Der Energieaustausch variiert nicht mit der Zeit.
    \end{itemize}

  \item Die Objekte sind \emph{vollkommen diffuse} Strahler
    \bzw Reflektoren, \dH sie erscheinen aus jeder Richtung
    „gleich hell“.

    \begin{center}
      \scalebox{0.5}{\huge\input{fig_farbeRadiosityVollkommenDiffus}}
    \end{center}
  \end{itemize}
\end{description}
\Reached{WS14/15}{10}{2014/12/11}
\Reached{WS19/20}{11}{2019/12/19}

\pagebreak


\subsection{Raumwinkel}

\begin{description}
\item[\emph{Raumwinkel\index{Raumwinkel} (Solid Angle\index{Solid Angle}):}]
  der von einem Punkt $\point{P}$ aus durch eine Fläche $A$
  überdeckte Winkelbereich

\item[Einheit:] \emph{sr\index{sr, Steradiant} (Steradiant\index{Steradiant})}: 1\,sr ist der zu
  einer Fläche 1 auf der Einheitskugel gehörende Raumwinkel.

  \begin{center}
    \scalebox{0.6}{\LARGE\input{fig_farbeRadiosityRaumwinkel1}}%ω
  \end{center}
\end{description}

\begin{beispiel}
  Die gesamte Einheitskugel besitzt die Oberfläche $4 π$.

  \begin{itemize}
  \item[⇒] Sie verdeckt (vom Mittelpunkt aus) den Raumwinkel
    $ω = 4 π \, \text{[sr]}$.
  \end{itemize}
\end{beispiel}

\pagebreak

\begin{bemerkung}\label{bem:verkuerzteFlaeche}
  Von $\point{P}$ aus ist statt $\dd A$ nur die „verkürzte“
  Fläche $\dd A · \cos φ$ sichtbar.

  \cmt{$φ$: Winkel zwischen Normale $\vektor{n}$ zu $\dd A$ und
    Projektionsrichtung $\overrightarrow{\dd A \point{P}}$}

  \begin{center}
    \scalebox{0.6}{\LARGE\input{fig_farbeRadiosityRaumwinkel2}}%φω
  \end{center}

  \begin{itemize}
  \item[⇒] \quad
    $\displaystyle \dd ω = \frac{\cos φ}{r²} \dd A$
  \end{itemize}

  Damit verdeckt $A$ von $\point{P}$ aus den Raumwinkel
  \[ ω = ∫_A \frac{\cos φ}{r²} \, \dd A
    \qquad
    \text{\cmt{$φ$ und $r$ hängen von $\dd A$ ab!}} \]
  (falls $A$ sich nicht teilweise selbst verdeckt).
\end{bemerkung}


\subsection{Radiosity}%
\label{subsec:radiosity}

\begin{description}
\item[\emph{Radiosity:}\index{Radiosity}] die von einem Objekt pro Zeit- und
  \emph{sichtbarer} Flächeneinheit
  abgestrahlte Energie
  $\displaystyle{\ek{\frac{\text{W}}{\text{m²}}}}$

\item[Radiance (Strahldichte):] die von einem Objekt pro Zeit- und
  sichtbarer Flächeneinheit in eine bestimmte Richtung
  abgestrahlte Energie pro Steradiant
  $\displaystyle{\ek{\frac{\text{W}}{\text{m²} · \text{sr}}}}$
\end{description}

\begin{bemerkungen} \mbox{}
  \begin{enumerate}
  \item Da das Objekt völlig diffus abstrahlt, ist die Radiosity
    unabhängig von der Richtung.

  \item Wegen der Gleichgewichtsannahme kann man Leistung
    $[\text{W}]$ und Energie $[\text{J}]$ gleichwertig
    verwenden.
  \end{enumerate}
\end{bemerkungen}

\begin{beispiel}
  Wie viel Energie strahlt eine Fläche $\dd A$ der Radiosity $B$
  insgesamt (pro Zeiteinheit) ab?

  \begin{center}
    \scalebox{0.5}{\huge\input{fig_farbeRadiosityEnergie}}%φ
  \end{center}

  \pagebreak

  \vspace*{-22mm}
  Von einem Punkt $\point{P}$ auf der Einheitskugel aus ist statt $\dd A$
  nur die „verkürzte“ Fläche $\dd A · \cos φ$ sichtbar.

  Die gesamte Strahlung von $\dd A$ in Richtung $\point{P}$ ist also
  \[ B · \dd A · \cos φ \,\text. \]

  Die Punkte mit gleichem $φ$ überdecken auf der Einheitskugel
  die Fläche
  \[ 2π \underbrace{\sin φ}_{\parbox[t]{2.5cm}{\small Radius des \\ „Streifens“}}
    · \underbrace{\dd φ}_{\parbox[t]{2.5cm}{\small Breite des \\ „Streifens“}}
    = \underbrace{\dd ω}_{\parbox[t]{2.5cm}{\small überdeckter \\ Raumwinkel}} \,\text. \]

  Sie erhalten also die Leistung
  \[ B · \dd A · \cos φ · 2π \sin φ · \dd φ \,\text. \]

  \enlargethispage{5mm}
  Also gibt $\dd A$ insgesamt die Leistung
  \begin{align}
    E_{\dd A} &= ∫₀^{\frac{π}{2}} B · \dd A · \cos φ · 2π \sin φ · \dd φ \nonumber \\
    &= 2π B \dd A ∫₀^{\frac{π}{2}} \cos φ \sin φ \, \dd φ \nonumber \\
    &= 2π B \dd A · \left. \frac12 \sin² φ \right|₀^{\frac{π}{2}} \nonumber \\
    &= π B \dd A \label{eq:radiosityEdA}
  \end{align}
  ab (auf eine Halbkugel über $\dd A$ verteilt).
\end{beispiel}

\pagebreak


\subsection{Von den Objekten zum Gleichungssystem}

\begin{description}
\item[Ansatz:] \mbox{}
  \[ \underbrace{\text{abgestrahlte
        Energie}^{\mymagenta{*}}}_{\text{\small Radiosity }
      · \text{ \small Fläche}}
    = \underbrace{\text{emittierte
        Energie}^{\mymagenta{*}}}_{\parbox{3.2cm}{\small Emission pro \\
        Flächeneinheit } · \text{ \small Fläche}}
    + \underbrace{\text{reflektierte
        Energie}^{\mymagenta{*}}}_{\parbox{2.5cm}{\small
        Reflexions\-koeffizient } · \: \parbox{5cm}{ \small von allen
        Objekten \\ einfallende
        Energie${}^{\mymagenta{*}}$}} \]
  \mymagenta{${}^*$:
    pro Zeiteinheit
    $\displaystyle{\ek{\text{W}}}$}
\end{description}

\begin{equation}
  \label{eq:radiosityKontinuierlich}
  Bᵢ · \dd Aᵢ = Eᵢ · \dd Aᵢ + ρᵢ · ∫_Ω Bⱼ · F_{\dd Aⱼ, \dd Aᵢ} · \dd Aⱼ
\end{equation}

\begin{tabular}{ll}
  $\dd Aᵢ$: & betrachtete Fläche \\
  $Bᵢ$: & Radiosity der Fläche $\dd Aᵢ$
  $\ek{\frac{\text{W}}{\text{m²}}}$ \\
  $Eᵢ$: & Eigenemission der Fläche $\dd Aᵢ$
  $\ek{\frac{\text{W}}{\text{m²}}}$ \\
  $ρᵢ$: & Reflexionskoeffizient der Fläche $\dd Aᵢ$
  (welcher Anteil des einfallenden Lichts wird reflektiert?) \\
  $\dd Aⱼ$: & irgendeine Fläche auf irgendeinem Objekt \\
  $Bⱼ$: & Radiosity der Fläche $\dd Aⱼ$ \\
  $Ω$: & gesamte Fläche aller Objekte \\
  $F_{\dd Aⱼ, \dd Aᵢ}$: & \emph{Formfaktor}\index{Formfaktor} (der
  Anteil der von $\dd Aⱼ$ insgesamt
  abgestrahlten Energie $[\text{W}]$, der bei $\dd Aᵢ$ ankommt)
\end{tabular}

\pagebreak

\begin{bemerkung}
  In den $F_{\dd Aⱼ, \dd Aᵢ}$ steckt die „Geometrie“ der Szene:
  \begin{itemize}
  \item Entfernung der Flächen $\dd Aᵢ$ und $\dd Aⱼ$
  \item ihre relative Orientierung
  \item die Sichtbarkeit (Liegt ein Objekt dazwischen?)
  \end{itemize}
\end{bemerkung}

\begin{description}
\item[Problem:] In der kontinuierlichen
  Formulierung \eqref{eq:radiosityKontinuierlich}
  kann der Lichtaustausch nicht (mit dem Computer) berechnet werden.

\item[\textmd{⇒} \emph{Diskretisierung}:] Zerlege die Objekte in insgesamt $\mdef{n}$
  Flächenstücke \emph{(Patches)}\index{Patch bei Radiosity}\index{Radiosity!Patch}
  $Aᵢ$.
  Für jeden Patch werden
  \begin{itemize}
  \item Radiosity $Bᵢ$,
  \item Eigenemission $Eᵢ$ und
  \item Reflexionskoeffizient $ρᵢ$
  \end{itemize}
  als konstant angesetzt.
\end{description}

\pagebreak

\vspace*{-16mm}
Dies führt auf
\begin{equation}
  \label{eq:radiosityDiskret}
  Bᵢ · Aᵢ = Eᵢ · Aᵢ + ρᵢ · ∑ⱼ₌₁ⁿ Bⱼ · Fⱼᵢ · Aⱼ
\end{equation}
mit den \emph{Formfaktoren}\index{Formfaktor} $Fⱼᵢ$.

\cmt{Welcher Anteil der von $Aⱼ$ insgesamt abgestrahlten Energie
  erreicht $Aᵢ$?}

In Abschnitt~\ref{subsec:faerbungFormfaktoren} wird die Beziehung
\begin{equation}
  Fⱼᵢ · Aⱼ = Fᵢⱼ · Aᵢ
  \label{eq:radiositySymmetrie}
\end{equation}
gezeigt.
Einsetzen in \eqref{eq:radiosityDiskret} und Division durch $Aᵢ$
liefert
\[ Bᵢ = Eᵢ + ρᵢ · ∑ⱼ₌₁ⁿ Bⱼ · Fᵢⱼ \]
\bzw
\[ \rk{1 - ρᵢ Fᵢᵢ} · Bᵢ - ∑_{j≠i} ρᵢ · Fᵢⱼ · Bⱼ = Eᵢ \]
\bzw
\begin{equation}
  \label{eq:radiosityLGS}
  \mdef{\underbrace{\black{\pmat{1 - ρ₁ F₁₁ & -ρ₁ F₁₂ & ⋯ & -ρ₁ F₁ₙ \\
          -ρ₂ F₂₁ & 1 - ρ₂ F₂₂ & ⋯ & -ρ₂ F₂ₙ \\ ⋮ & ⋮ && ⋮ \\
          -ρₙ Fₙ₁ & -ρₙ Fₙ₂ & ⋯ & 1 - ρₙ Fₙₙ}}}_{\textstyle\text{\emph{Radiosity Matrix} } M_R}}
  · \pmat{B₁ \\ B₂ \\ ⋮ \\ Bₙ}
  = \pmat{E₁ \\ E₂ \\ ⋮ \\ Eₙ} \,\text.
\end{equation}\index{Radiosity Matrix}

\pagebreak

\pngpage[\imglic{Hugo Elias (myself)}%
{\urllic{https://commons.wikimedia.org/wiki/File:Radiosity_Comparison.jpg}}%
{„Radiosity Comparison“}
{\ccbysa~3.0, \urllic{https://creativecommons.org/licenses/by-sa/3.0/legalcode}}]{%
  Bilder/wikimedia/radiosity-comparison}

\pagebreak

\vspace*{-22mm}
\begin{bemerkungen} \mbox{}
  \begin{enumerate}
  \item $ρᵢ$ und $Eᵢ$ sind \iA abhängig von der
    Wellenlänge $λ$.

    \begin{itemize}
    \item[⇒] Für jede betrachtete Wellenlänge muss ein
      solches System gelöst werden.
    \end{itemize}

    ($Fᵢⱼ$ wird meist als $λ$-unabhängig betrachtet.)

  \item $Fᵢᵢ = 0$, falls der zugehörige Patch $Aᵢ$ eben oder
    konvex ist,

    $Fᵢᵢ > 0$, falls $Aᵢ$ konkav ist; dann fällt ein Teil
    der abgestrahlten Energie wieder auf $Aᵢ$.

    \begin{center}
      \scalebox{0.5}{\huge\input{fig_farbeRadiosityKonkav}}%ᵢ
    \end{center}

    \vspace*{-15mm}
  \item $\displaystyle{∑ⱼ₌₁ⁿ Fᵢⱼ = 1}$

    (wegen der Annahme, dass alles von $Aᵢ$ abgestrahlte Licht
    wieder auf die Patches $Aⱼ$ fällt)

  \item $Fᵢⱼ = 0$, wenn $Aⱼ$ von $Aᵢ$ aus unsichtbar
    (verdeckt) ist.

    \begin{itemize}
    \item[⇒] Die Radiosity Matrix ist meist \emph{dünn besetzt}

      (typisch: ca.\ 10\,\% der $Fᵢⱼ$ sind $≠ 0$).
    \end{itemize}

    Die Matrix ist aber \emph{ziemlich groß}
    (meist $n ∼ 10⁴ \text{ – } 10⁶$).

    \begin{itemize}
    \item[⇒] hoher Speicherbedarf
      ($≫ 10⁶$ Koeffizienten $≠ 0$)
    \end{itemize}

  \item $Eᵢ = 0$, außer wenn $Aᵢ$ selbst leuchtet.
  \end{enumerate}
  \Reached{WS16/17}{12}{2017/01/19}
\end{bemerkungen}


\subsection{Vom Gleichungssystem zum Bild}

Die Lösung des Gleichungssystems gibt die Helligkeit der Patches an;
sie ist \emph{unabhängig davon, von wo aus die Szene betrachtet wird}.

\begin{itemize}
\item[⇒] Aus der Lösung können mit geringem Aufwand mehrere
  Ansichten der Szene erstellt werden

  (\zB „Walk Through“-Animation in Echtzeit).
\end{itemize}

Die eigentliche Bilderzeugung erfordert dann nur noch die Wiedergabe der
Patches.
Dies geschieht \zB mit einer Kombination aus
\begin{itemize}
\item geeigneter 3D → 2D-Transformation,
\item $z$-Puffer-Algorithmus,
\item Gouraud-Shading.
\end{itemize}

\begin{description}
\item[Problem:] Beim Radiosity-Verfahren erhält jeder \emph{Patch} konstante
  Helligkeit zugeordnet.
  Hieraus müssen Helligkeiten für die \emph{Knoten} abgeleitet
  werden, so dass Gouraud-Shading an den Objekt-internen
  Patchgrenzen stetige Farbübergänge liefert.

\item[Ansatz:] Inter- \bzw Extrapolation

  \begin{center}
    \scalebox{0.5}{\huge\input{fig_farbeRadiosityInterpolation}}%ₐₑᵢᵣ
  \end{center}

  \begin{description}
  \item[Fall~1:] $\point{V}ᵢ$ ist „innere Ecke“.
    \[ B\fk{\point{V}ᵢ} := \frac14 ·
      \rk{\underbrace{Bₐ + B_b + B_c + B_d}_{\text{Radiosities der mit $\point{V}ᵢ$
            inzidenten Patches}}} \]

  \item[Fall~2:] $\point{V}ᵣ$ ist „Randecke“, aber nicht
    Ecke des Objekts.

    Seien $A_b$ und $A_d$ die mit $\point{V}ᵣ$ inzidenten
    Patches, $\point{V}ᵢ$ der andere (im Innern des Objektes
    gelegene) Endpunkt und $\point{M}$ der Mittelpunkt der
    Grenze $A_b | A_d$.
    \[ B\fk{\point{V}ᵣ} := 2 B(\point{M}) - B\fk{\point{V}ᵢ} \]
    mit
    \[ B(\point{M}) := \frac12 · \rk{B_b + B_d} \]

  \item[Fall~3:] $\point{V}ₑ$ ist Ecke des Objekts.

    Sei $A_b$ der mit $\point{V}ₑ$ inzidente Patch und
    $\point{V}ᵢ$ die (auf $A_b$) „gegenüberliegende“
    innere Ecke.
    \[ B\fk{\point{V}ₑ} := 2 B_b - B\fk{\point{V}ᵢ} \]
  \end{description}
\end{description}
\Reached{WS15/16}{10}{2016/01/14}


\subsection{Die Formfaktoren}
\label{subsec:faerbungFormfaktoren}

Von $\dd Aᵢ$ aus ist statt $\dd Aⱼ$ nur die verkürzte Fläche
\[ \dd Aⱼ' = \dd Aⱼ · \cos φⱼ \]
sichtbar.

\begin{center}
  \scalebox{0.5}{\huge\input{fig_farbeRadiosityFormfaktor}}%φωᵢⱼ
\end{center}

Von $\dd Aⱼ$ aus erscheint die (verkürzte) Fläche $\dd Aᵢ'$ unter
dem Raumwinkel
\[ \dd ω = \frac{\dd Aᵢ · \cos φᵢ}{r²} \,\text. \]
Also erhält $\dd Aᵢ$ von $\dd Aⱼ$ die Energie
\begin{align*}
  E_{\dd Aⱼ,\dd Aᵢ} &= Bⱼ · \dd Aⱼ' · \dd ω ·
  \underbrace{Hⱼᵢ}_{\makebox(0,0)[t]{\small \begin{tabular}{ll}
        $= 1$ & falls $\dd Aⱼ$ von $\dd Aᵢ$ aus sichtbar ist \\
        $= 0$ & sonst\end{tabular}}} \\[16mm]
  &= \frac{Bⱼ · \cos φᵢ · \cos φⱼ}{r²} · Hⱼᵢ · \dd Aⱼ · \dd Aᵢ \,\text,
\end{align*}

und damit erhält Patch $Aᵢ$ von Patch $Aⱼ$ die Energie
\[ E_{Aⱼ, Aᵢ} = ∫_{Aᵢ} ∫_{Aⱼ} \frac{Bⱼ · \cos φᵢ · \cos φⱼ}{r²} · Hⱼᵢ · \dd Aⱼ · \dd Aᵢ \,\text. \]
Die gesamte Abstrahlung von $Aⱼ$ ist
\begin{align*}
  E_{Aⱼ} &= ∫_{Aⱼ} E_{\dd Aⱼ} \, \dd Aⱼ \\
  &= ∫_{Aⱼ} π Bⱼ \, \dd Aⱼ
  \qquad \text{\cmt{gemäß \eqref{eq:radiosityEdA}}} \\
  &= π Bⱼ Aⱼ \,\text.
\end{align*}
Damit folgt
\begin{equation}
  Fⱼᵢ = \frac{E_{Aⱼ, Aᵢ}}{E_{Aⱼ}}
  = \frac{1}{Aⱼ} · ∫_{Aᵢ} ∫_{Aⱼ} \frac{\cos φᵢ · \cos φⱼ}{π r²}
  Hⱼᵢ \, \dd Aⱼ \, \dd Aᵢ \,\text.
  \label{eq:radiosityFormfaktorIntegral}
\end{equation}

\begin{bemerkungen} \mbox{}
  \begin{enumerate}
  \item Aus \eqref{eq:radiosityFormfaktorIntegral} folgt wegen
    $Hⱼᵢ = Hᵢⱼ$ sofort die Symmetriebeziehung \eqref{eq:radiositySymmetrie}.

  \item Für die Berechnung der $Fᵢⱼ$ mit dem Computer ist
    \eqref{eq:radiosityFormfaktorIntegral} nicht zu gebrauchen
    (Vierfach-Integral, \usw).

  \item \eqref{eq:radiosityFormfaktorIntegral} könnte mit dem
    Satz von Stokes in ein doppeltes Kontur-Integral umgewandelt
    werden.
  \end{enumerate}
\end{bemerkungen}
\Reached{WS18/19}{11}{2019/01/10}

\pagebreak


\subsection{Numerische Berechnung der Formfaktoren}

\begin{description}
\item[Vereinfachung 1:] $φᵢ$, $φⱼ$, $r$ und $Hⱼᵢ$ seien unabhängig
  von dem gerade auf $Aⱼ$ betrachteten Punkt.

  (liefert gute Näherung, falls $Aⱼ$ klein gegenüber $r$)
\end{description}

Einsetzen in \eqref{eq:radiosityFormfaktorIntegral} ergibt
\begin{align}
  Fⱼᵢ &= \frac{1}{Aⱼ} · ∫_{Aᵢ} \frac{\cos φᵢ · \cos φⱼ}{π r²} Hⱼᵢ \, \dd Aᵢ
  · ∫_{Aⱼ} \dd Aⱼ \nonumber \\
  &= ∫_{Aᵢ} \frac{\cos φᵢ · \cos φⱼ}{π r²} Hⱼᵢ \, \dd Aᵢ \,\text.
  \label{eq:radiosityFormfaktorVereinfachung1}
\end{align}
Als „Referenzpunkt“ $\point{P}ⱼ$ auf $Aⱼ$ wird dann
beispieleweise der Mittelpunkt von $Aⱼ$ gewählt.

\pagebreak

\vspace*{-18mm}
\begin{bemerkung}
  Der Wert $Fⱼᵢ$ in \eqref{eq:radiosityFormfaktorVereinfachung1}
  kann auch geometrisch gewonnen werden (ohne Beweis).

  \begin{center}
    \scalebox{0.5}{\huge\input{fig_farbeRadiosityFormGeometrisch}}%ᵢⱼ
  \end{center}

  \begin{itemize}
  \item Projiziere den sichtbaren Teil von $Aᵢ$ auf die
    Einheitshalbkugel
    \cmt{in Richtung $\widehat{\vektor{n}}ⱼ$}
    um $\point{P}ⱼ$.

    (Dies liefert
    $\displaystyle{∫_{Aᵢ} \frac{\cos φᵢ}{r²} Hⱼᵢ \, \dd Aᵢ}$.)

  \item Projiziere diese Fläche auf den „Grundkreis“ der
    Halbkugel (liefert $\cos φⱼ$).

  \item Dividiere diese Fläche durch die Kreisfläche
    (liefert $\frac1π$).
  \end{itemize}

  Der Formfaktor ist also aus der Projektion des Patches $Aᵢ$ auf
  die Einheitskugel (Größe und Lage der projizierten Fläche)
  ableitbar.
\end{bemerkung}

\begin{description}
\item[Beobachtung:] Statt der Einheitshalbkugel ist auch eine beliebige konvexe
  „Halbumgebung“ von $\point{P}ⱼ$ verwendbar, \zB ein
  \emph{Halbwürfel}:

  \begin{center}
    \scalebox{0.45}{\huge\input{fig_farbeRadiosityFormZellen1}}%ᵢⱼ
  \end{center}

  (Vom Halbwürfel kann „weiter“ auf die Halbkugel projiziert
  werden.)

  \pagebreak

\item[Vereinfachung 2:] Zerlege die Oberfläche des Halbwürfels in kleine Flächenstücke
  \emph{(Zellen)}\index{Zelle bei Formfaktorberechnung}\index{Formfaktor!Zelle}
  $C_q$ und ersetze die Projektion durch die Vereinigung der davon
  erfassten Zellen (≙ \emph{Diskretisierung}).

  \begin{center}
    \scalebox{0.425}{\huge\input{fig_farbeRadiosityFormZellen2}}%ᵢⱼ
  \end{center}

\item[Beobachtung:] Jede Zelle $C_q$ liefert einen Beitrag $ΔF_q$ zu
  $Fⱼᵢ$:
  \[ Fⱼᵢ = ∑_{q : \text{$C_q$ wird bei der Projektion von $Aᵢ$ erfasst}} ΔF_q \]
  mit
  \[ Δ F_q = \frac{\text{Projektion von $C_q$ auf Einheitskugel und
        Kreis}}{\text{Kreisfläche}} \]
\end{description}

\pagebreak

\begin{bemerkung}
  Die  \emph{Delta-Formfaktoren}\index{Delta-Formfaktor} $ΔF_q$
  hängen nur von der Unterteilung des Würfels in Zellen ab, nicht von
  projiziertem Patch $Aᵢ$ oder von $Aⱼ$
  \cmt{letzteres nur, wenn alle Halbwürfel um die $\point{P}ⱼ$ gleich unterteilt werden}.

  \begin{itemize}
  \item[⇒] Die $ΔF_q$ können \emph{vorab} berechnet werden!
  \end{itemize}

  Oft ist es günstiger, die zu verschiedenen $Pⱼ$ gehörigen
  Halbwürfel – oder sogar die verschiedenen Flächen eines
  Halbwürfels – unterschiedlich fein zu unterteilen.
  Dann sind mehrere (\zB 4) „Sätze“ der $ΔF_q$ zu
  speichern.

  typische Anzahl der Zellen pro Halbwürfelfläche: 100 – 100\,000
\end{bemerkung}

\pagebreak

\begin{description}
\item[Berechnung der Delta-Formfaktoren:] \mbox{}

  \begin{center}
    \scalebox{0.5}{\huge\input{fig_farbeRadiosityFormZellen3}}%φ
  \end{center}
\end{description}

Gemäß \eqref{eq:radiosityFormfaktorVereinfachung1} gilt
\[ ΔF_q = ∫_{C_q} \frac{\cos φ_q · \cos φ_{\point{P}}}{π r²} \, \dd C_q \,\text.\]
\cmt{$H ≡ 1$, da die ganze Zelle von $\point{P}$ aus sichtbar ist.}

\begin{description}
\item[Vereinfachung 3:] $φ_q$, $φ_{\point{P}}$ und $r$ seien unabhängig von
  dem gerade auf $C_q$ betrachteten Punkt $\point{P}_q$.
\end{description}

Dann ist
\[ ΔF_q = \frac{\cos φ_q · \cos φ_{\point{P}}}{π r²}
  · \underbrace{C_q}_{\text{Fläche der Zelle}} \,\text. \]

Als „Referenzpunkt“ wählt man etwa den Mittelpunkt
$\point{P}_q = \rk{r_q, s_q, t_q}$ von $C_q$.

\begin{description}
\item[Fall a:] $C_q$ liegt auf der „Deckfläche“ des Würfels.

  \begin{center}
    \scalebox{0.5}{\huge\input{fig_farbeRadiosityFormZellen3}}
  \end{center}

  Dann ist
  \begin{align*}
    t_q &= 1 \,, \\
    r &= \sqrt{r_q² + s_q² + t_q²} = \sqrt{r_q² + s_q² + 1} \,\text, \\
    \cos φ_q &= \cos φ_{\point{P}} = \frac1r
  \end{align*}
  und damit
  \[ ΔF_q = \frac{C_q}{π r⁴} = \frac{C_q}{π \rk{r_q² + s_q² + 1}²} \,\text. \]

  \pagebreak

\item[Fall b:] $C_q$ liegt auf einer Seitenfläche $s_q = ±1$.

  \begin{center}
    \scalebox{0.5}{\huge\input{fig_farbeRadiosityFormZellen4}}%φ
  \end{center}

  Dann ist
  \begin{align*}
    r &= \sqrt{r_q² + 1 + t_q²} \,\text, \\
    \cos φ_q &= \frac1r \,\text, \\
    \cos φ_{\point{P}} &= \frac{t_q}{r}
  \end{align*}
  und damit
  \[ ΔF_q = \frac{t_q · C_q}{π \rk{r_q² + 1 + t_q²}²} \,\text. \]

\item[Fall c:] $C_q$ liegt auf einer Seitenfläche $r_q = ±1$.
  Dann folgt analog
  \[ ΔF_q = \frac{t_q · C_q}{π \rk{1 + s_q² + t_q²}²} \,\text. \]
\end{description}

\begin{bemerkung}
  Aus Symmetriegründen müssen nur die Delta-Formfaktoren für ein
  Achtel der Deckfläche und eine halbe Seitenfläche wirklich
  berechnet werden.
\end{bemerkung}

\pagebreak

\begin{description}
\item[Problem:] Wie bestimmt man möglichst effizient die von der Projektion (der
  nicht verdeckten Teile) von $Aᵢ$ erfassten Zellen?

\item[Idee:] Die Zellen auf einer Fläche des Halbwürfels können als
  \emph{Pixmap} interpretiert werden.

  \begin{itemize}
  \item[⇒] Die erfassten Zellen ergeben sich durch
    perspektivische Projektion \bzgl $\point{P}ⱼ$ und
    anschließende \emph{Scan Conversion}.
  \end{itemize}

  Mit einem \emph{$\mathbf{z}$-Puffer}-ähnlichen Ansatz kann dabei auch
  gleich die Verdeckungsanalyse durchgeführt werden.

  \begin{itemize}
  \item[⇝] \emph{Objektpuffer}\index{Objektpuffer zur Formfaktorberechnung}%
    \index{Formfaktor!Objektpuffer}:
    Speichere für jede Zelle $C_q$ die Nummer $i_q$ und
    die Entfernung $d_q$ des dort gerade sichtbaren Patches.

    \begin{center}
      \scalebox{0.5}{\Large\input{fig_farbeRadiosityFormZellen5}}%₁₂₃ⱼ
    \end{center}
  \end{itemize}
\end{description}

\pagebreak

\begin{algorithmus} \mbox{}
  \begin{AlgListInline}
    Algorithmus Bestimmung der Formfaktoren $Fⱼᵢ$, $\myred{i = 1, …, n}$

    // Initialisiere Objektpuffer
    für alle Zellen $C_q$ des Halbwürfels
    °°°$\rk{i_q, d_q}$ := $\rk{0, +∞}$°°°°°°°// „Hintergrund“
    // Projiziere alle $Aᵢ$ auf den Halbwürfel um $\point{P}ⱼ$
    für $i = 1, …, n$
    °°°für jede der fünf Flächen des Halbwürfels
    °°°°°°projiziere $Aᵢ$ auf die Fläche und führe Scan Conversion durch
    °°°°°°für jede hierbei gelieferte Zelle $C_q$
    °°°°°°°°°bestimme den Abstand $d$ des zugehörigen Punktes auf $Aᵢ$ von $\point{P}ⱼ$
    °°°°°°°°°wenn $d < d_q$°°°°°°°// Patch $Aᵢ$ bei $C_q$ sichtbar?
    °°°°°°°°°°°°$\rk{i_q, d_q}$ := $\rk{i, d}$
    // Berechne aus den Projektionen die Formfaktoren
    für $i = 1, …, n$
    °°°$Fⱼᵢ$ := $∑_{q : i_q=i} ΔF_q$°°°°°°°// Summe über die Zellen, bei denen $Aᵢ$ sichtbar ist
  \end{AlgListInline}
\end{algorithmus}

\pagebreak

\begin{bemerkungen} \mbox{}
  \begin{enumerate}
  \item Vereinfachung~1 (ersetze $Aⱼ$ durch $\point{P}ⱼ$)
    führt dazu, dass sich ausgedehnte Lichtquellen (\zB Fenster,
    Leuchtkörper) wie Punktlichtquellen verhalten.

    \begin{center}
      \scalebox{0.5}{\huge\input{fig_farbeRadiosityLichtquellen}}
    \end{center}

    \begin{itemize}
    \item[⇒] Ausgedehnte Lichtquellen müssen \iA in relativ
      kleine Patches zerlegt werden.
    \end{itemize}

  \item Alle drei Vereinfachungen können zu wesentlichen Fehlern in
    den $Fⱼᵢ$ führen, wenn

    \begin{itemize}
    \item die Patches (relativ zu ihrer Größe) nahe
      beieinander liegen, \zB aneinanderstoßen

      \begin{verse}
        (\textbf{Regel:}
        $\text{Abstand} ≥ 5 · \text{Patchdurchmesser}$)
      \end{verse}

    \item der Halbwürfel in zu wenige Zellen unterteilt wird.
    \end{itemize}

  \item trotz der Vereinfachungen \emph{sehr hoher Aufwand}:
    \[ \underbrace{\text{\emph{$n$-mal }}}_{\makebox(0,0)[t]{\small
          für $j = 1, …, n$}}
      \text{\emph{ komplette }}
      \underbrace{\text{\emph{ „Bilderzeugung“}}}_{\parbox[t]{4cm}{\small
          Projektion\par
          Scan Conversion\par
          Verdeckungsanalyse}} \]
    allerdings für „Pixmaps“ verhältnismäßig geringer
    Auf\/lösung
  \end{enumerate}
\end{bemerkungen}
\Reached{WS17/18}{12}{2018/01/11}

\pagebreak


\subsection{Schrittweiser Lösungsaufbau}

\begin{description}
\item[Motivation:] \mbox{}

  \begin{itemize}
  \item Die Berechnung der $Bᵢ$ ist sehr aufwändig.

    \begin{itemize}
    \item[⇒] Ist es möglich, schon relativ früh eine
      „grobe“ Näherung zu erhalten und diese im Laufe
      der Zeit zu verbessern?
    \end{itemize}

  \item Die $Fⱼᵢ$ erfordern sehr viel Speicher.

    \begin{itemize}
    \item[⇒] Kann das Verfahren so umstrukturiert
      werden, dass immer nur ein kleiner Teil der $Fⱼᵢ$
      gleichzeitig benötigt wird?
    \end{itemize}
  \end{itemize}
\end{description}

\begin{description}
\item[Ansatz:] geeigneter iterativer Algorithmus zur Lösung des LGS
\end{description}

\emph{Gauß-Seidel-Verfahren} zur Lösung von
\eqref{eq:radiosityLGS}:

\begin{AlgListInline}
  starte mit $Bᵢ = Eᵢ$, $i = 1, …, n$
  wiederhole bis gewünschte Genauigkeit erreicht
  °°°für $i = 1, …, n$
  °°°°°°$Bᵢ$ := $Eᵢ + ρᵢ · ∑ⱼ₌₁ⁿ Fᵢⱼ · Bⱼ$
\end{AlgListInline}

Die neue Radiosity $Bᵢ$ von $Aᵢ$ ergibt sich also durch
„Einsammeln“ \emph{(Gather)}\index{Gather bei Radiosity}\index{Radiosity!Gather}
der Beiträge $ρᵢ · Fᵢⱼ · Bⱼ$ der anderen Patches.

\pagebreak

\begin{description}
\item[Idee:] Betrachte die umgekehrte Abhängigkeit: (nach Cohen/Chen/Wallace/Greenberg 1988)

  Wie ändern sich die übrigen Radiosities, wenn sich $Bᵢ$ um
  $ΔBᵢ$ ändert \emph{(Shoot)}\index{Shoot bei Radiosity}\index{Radiosity!Shoot}?

  \begin{center}
    \scalebox{0.45}{\huge\input{fig_farbeRadiosityGatherShoot}}%Δρᵢⱼ
  \end{center}
  \personHidden{-5mm}{Michael F.~Cohen}{}{}{}{person_CohenM}{}%
  {\urlpers{https://www.siggraph.org/about/awards/1998-cg-award/}}{}%
  
  \personHidden{-15mm}{Shenchang Eric Chen}{}{}{}{person_Chen}{}%
  {\urlpers{https://www.linkedin.com/in/ec19801}}%
  {}%
  
  \personHidden{-25mm}{John R.~Wallace}%
  {}{}{}%
  {person_nopic}{}{}{}%
  \vspace*{40mm}
  \Reached{WS19/20}{12}{2020/01/09}

  \pagebreak

  \vspace*{-19mm}
\item[Antwort] auf die Frage:
  \vspace*{-9mm}
  \begin{align*}
    ΔBⱼ &= ρⱼ Fⱼᵢ · ΔBᵢ \\
    &= ρⱼ Fᵢⱼ · \frac{Aᵢ}{Aⱼ} · ΔBᵢ \qquad
    \text{\cmt{gemäß \eqref{eq:radiositySymmetrie}}}
  \end{align*}
\end{description}

\begin{algorithmus} \mbox{}
  \begin{AlgListInline}
    Algorithmus Schrittweiser Lösungsaufbau

    für $i = 1, …, n$
    °°°$Bᵢ$ := $Eᵢ$°°°°°°°// berücksichtige nur Eigenemission
    °°°$\widetilde{Δ}Bᵢ$ := $Eᵢ$ °°°°°°°// um wie viel hat sich $Bᵢ$ geändert, seit $Aᵢ$ letztmalig ausgewählt wurde?
    ggf. §Ansicht§ erstellen
    wiederhole bis gewünschte Genauigkeit erreicht
    °°°wähle einen Patch $Aᵢ$ mit maximalem $\widetilde{Δ}Bᵢ · Aᵢ$°// Maß für Änderung der ges. abgestrahlten Energie
    °°°bestimme $Fᵢⱼ$, $j = 1, …, n$
    °°°für $j = 1, …, n$
    °°°°°°$ΔBⱼ$ := $ρⱼ Fᵢⱼ \frac{Aᵢ}{Aⱼ} · Δ Bᵢ$
    °°°°°°$Bⱼ$ := $Bⱼ + ΔBⱼ$
    °°°°°°$\widetilde{Δ}Bⱼ$ := $\widetilde{Δ}Bⱼ + ΔBⱼ$
    °°°ggf. §Ansicht§ erstellen
    °°°$\widetilde{Δ}Bᵢ$ := $0$
  \end{AlgListInline}
\end{algorithmus}

\pagebreak

\begin{bemerkungen} \mbox{}
  \begin{enumerate}
  \item Zu Beginn sind nur die selbst emittierenden Objekte
    sichtbar, dann wird der Beitrag des stärksten Strahlers an
    alle Objekte berücksichtigt, dann der zweitstärkste \usw

    \begin{itemize}
    \item[⇒] Die Szene ist anfangs überwiegend dunkel und
      hellt sich langsam auf.
    \end{itemize}

  \item Wenn die $Fᵢⱼ$ „schnell genug“ erzeugt werden
    können (\zB mit einer $z$-Puffer-Hardware), dann muss nur noch
    eine \emph{Zeile} der Radiosity-Matrix gespeichert werden; die
    Formfaktoren werden allerdings mehrmals berechnet.

    \begin{itemize}
    \item[⇒] Möglichkeit, die Formfaktoren im Laufe der
      Zeit zu ändern
    \end{itemize}
  \end{enumerate}
\end{bemerkungen}

\pagebreak

\pngpage{Bilder/radios/sceneSortMod-h500-00001}
\pngpage{Bilder/radios/sceneSortMod-h500-00015}
\pngpage{Bilder/radios/sceneSortMod-h500-00050}
\pngpage{Bilder/radios/sceneSortMod-h500-00400}
\pngpage{Bilder/radios/sceneSortMod-h500-00600}
\pngpage{Bilder/radios/sceneSortMod-h500-03000}
\pngpage{Bilder/radios/sceneSortMod-h500-25000}
\pngpage{Bilder/radios/sceneSortMod-h500-80000}

\pagebreak


\vspace*{-23mm}
\subsection{Unterteilung der Patches}

\begin{description}
\item[Problem:] Oft wird nach der Berechnung der Formfaktoren und dem Lösen des
  Gleichungssystems deutlich, dass die ursprüngliche Unterteilung
  in Patches zu grob war.

  \begin{description}
  \item[typisches Kriterium:] große Radiosity-Unterschiede
    zwischen benachbarten Patches

    \begin{itemize}
    \item[⇒] Die Patches enthalten einen deutlichen
      Farbübergang (\zB \emph{Schattengrenze}).

      Dieser wird bei der Wiedergabe der Patches
      „glattinterpoliert“.

      \begin{center}
        \scalebox{0.5}{\huge\input{fig_farbeRadiositySchattengrenze}}%ᵢⱼ
      \end{center}

    \item[⇝] Nach der Interpolation ist der Übergang
      nicht mehr lokalisierbar.
    \end{itemize}
  \end{description}

\item[Ansatz I:] Erhöhe die Anzahl der Patches auf $N$ und fange wieder von vorne
  an:

  \begin{center}
    \begin{tabular}{Ll}
      \mdef{N²} & Formfaktoren berechnen \\
      \mdef{N × N} & Gleichungssysteme lösen
    \end{tabular}
  \end{center}

  \begin{itemize}
  \item[⇒] für $N ≫ n$ starke Zunahme des Aufwands
  \end{itemize}

\item[Ansatz II:] Unterteile, wo notwendig, die Patches in
  \emph{Elemente}\index{Element bei Radiosity}\index{Radiosity!Element}:
  \[ Aᵢ ⇝ A_{i,1}, …, A_{i,mᵢ} \]

  \begin{itemize}
  \item Der Einfluss der übrigen Patches $Aⱼ$ auf $Aᵢ$
    wird für jedes Element $A_{i,q}$ von $Aᵢ$ bestimmt.

    \begin{itemize}
    \item[⇒] Die Beleuchtungsverhältnisse auf $Aᵢ$
      können detaillierter modelliert werden.
    \end{itemize}

  \item Der Einfluss von $Aᵢ$ auf die übrigen $Aⱼ$ wird
    \emph{summarisch} bestimmt, \dH die Elemente von $Aᵢ$
    werden hierzu zusammengefasst.

    \begin{itemize}
    \item[⇒] Reduktion des Rechenaufwands
    \end{itemize}
  \end{itemize}

  \begin{enumerate}
  \item[i)] Berechne die $\mdef{N · n}$ Formfaktoren
    $F_{j,i_q}$
    \cmt{Anteil des von $Aⱼ$ ausgehenden Lichts, das bei
      Element $A_{i,q}$ eintrifft}
    \bzw $F_{i_q,j}$.

  \item[ii)] Verwende die Lösung $\rk{Bⱼ : j = 1, …, n}$
    des ursprünglichen $n × n$-Gleichungssystems und
    berechne hieraus die Element-Radiosities gemäß
    \begin{equation}
      \label{eq:radiosityElement}
      B_{i,q} = \underbrace{Eᵢ}_{\text{\evtl\ } E_{i,q}}
      + \underbrace{ρᵢ}_{\text{\evtl\ } ρ_{i,q}}
      · ∑ⱼ₌₁ⁿ Bⱼ F_{i_q,j} \,\text.
    \end{equation}
  \end{enumerate}

  \pagebreak

\item[Ansatz III:] ähnlich wie II, aber
  \begin{enumerate}
  \item[ii)] Berechne verbesserte
    „Patch-zu-Patch“-Formfaktoren
    \[ \widetilde{F}ᵢⱼ = \frac{1}{Aᵢ}
      · ∑_{q=1}^{mᵢ} F_{i_q,j} · A_{i,q} \]
    \cmt{Flächen-gewichtetes Mittel der $F_{i_q,j}$}.
    
  \item[iii)] Berechne die Patch-Radiosities $Bⱼ$ über ein
    $\mdef{n × n}$-Gleichungssystem (mit
    $\widetilde{F}ᵢⱼ$ statt $Fᵢⱼ$).
    
  \item[iv)] Berechne hieraus die Element-Radiosities gemäß
    \eqref{eq:radiosityElement}.
  \end{enumerate}
\end{description}

\pagebreak

\begin{bemerkungen} \mbox{}
  \begin{enumerate}
  \item Die Elemente werden \ggf nochmals unterteilt:

    \begin{AlgListInline}
      solange es noch benachbarte Patches/Elemente mit º„ºzu großemº“º Radiosity-Unterschied gibt
      °°°unterteile diese in kleinere Elemente
      °°°berechne Radiosities (zumindest) ºfürº die neuen Elemente
    \end{AlgListInline}

  \item Unterteilung in Elemente ändert nichts an der Tatsache,
    dass emittierende Patches wie Punktlichtquellen strahlen

    \begin{itemize}
    \item[⇒] Ausgedehnte Lichtquellen müssen (\iA bereits
      zu Beginn) in kleine \emph{Patches} zerlegt werden.
    \end{itemize}

  \item Die Unterteilung wird während des schrittweisen
    Lösungsaufbaus durchgeführt.
  \end{enumerate}
\end{bemerkungen}

\pagebreak

\vspace*{-32mm}
\subsection{Zusammenfassung}

\vspace*{-13mm}
\begin{center}
  \scalebox{0.45}{\huge\input{fig_farbeRadiosityAblauf}}%λρᵢ
\end{center}

\begin{itemize}
\item[\Good] trotz der vielen Vereinfachungen gute Simulation von
  %% \imagelink{Bilder/cornell_radiosity}

  \begin{itemize}
  \item (mehrfacher) diffuser Reflexion

  \item ausgedehnten Lichtquellen
  \end{itemize}

\item[\Good] unabhängig von Betrachtungsposition
  
  ⇝ für statische Szenen Vorabberechnung möglich, dann sehr schnelles Rendering

\item[\Bad] keine Berücksichtigung winkelabhängiger Phänomene:

  \begin{itemize}
  \item winkelabhängige Reflexion

  \item Refraktion
  \end{itemize}

\item[\Bad] feine Unterteilung in Patches nötig für gute Ergebnisse

\item[\Bad] Formfaktoren schwierig zu berechnen

\item[\Bad] insgesamt sehr aufwändig
\end{itemize}

\begin{bemerkung}
  Das Radiosity-Verfahren wird oft auf \emph{Innenräume} angewandt
  (Annahme eines geschlossenen Systems!).
  \Reached{WS14/15}{11}{2014/12/18}
  \Reached{WS15/16}{11}{2016/01/21}
  \Reached{WS16/17}{13}{2017/01/26}
\end{bemerkung}

\pagebreak

\pngpage{Bilder/yagir/cornell-radiosity}

\pagebreak

\mbox{}
\ReachedZoom{WS20/21}{11}{2021/01/21}
\Reached{WS21/22}{11}{2022/01/06}


\section{Rendergleichung und Monte-Carlo-Integration}

Notation von Funktionsargumenten mit Richtungen (nach
\cite{AdvancedGlobalIllumination2}):

\begin{tabular}{Cl}
  f(x → Θ) & Funktion $f(x, Θ)$, vom Punkt $x$ ausgehend in Richtung $Θ$ \\
  f(x ← Θ) & Funktion $f(x, Θ)$, den Punkt $x$ aus Richtung $Θ$ treffend \\
  f(x, Θ ↔ Ψ) & Funktion $f(x, Θ, Ψ)$, aus Richtung $Θ$ auf\/treffend und in
  Richtung $Ψ$ verlassend \bzw \\
  & umgekehrt (impliziert Helmholtz-Reziprozität [Umkehrbarkeit]) \\
  \rk{Ψᵀ · Θ} & Kosinus als Skalarprodukt normalisierter Vektoren
\end{tabular}

\pagebreak


\subsection{Radiance}

\begin{description}
\item[\emph{Radiance\index{Radiance} (Strahldichte\index{Strahldichte})}]
  (\vgl\ref{subsec:radiosity}): die von einem Objekt pro Zeit- und 
  sichtbarer Flächeneinheit in eine bestimmte Richtung
  abgestrahlte Energie pro Einheitsraumwinkel
\end{description}
% \imagelink{Grafiken/flux-irradiance-radiance}

\[ L(x, ω) = \frac{\ddq Φ(x, ω)}{\dd A \cos(φ) \dd ω} \]
\begin{tabular}{Ll}
  Φ & Strahlungsleistung (Strahlungsfluss, radiant flux) \\
  \dd A \cos(φ) & projiziertes Flächenelement \\
  \dd ω & Raumwinkelelement
\end{tabular}

\begin{center}
  \input{fig_renderFluxIrradianceRadiance}%φ, ω
\end{center}


\subsection{Rendergleichung}

\begin{description}
\item[\emph{Rendergleichgung \index{Rendergleichung} (rendering equation)}] \mbox{} \\
  1986 unabhängig von Immel/Cohen/Greenberg und Kajiya aufgestellt:
  
  \personHidden{10mm}{David S.~Immel}{}{}{}{person_nopic}{}{}{}%

  \person{-5mm}{James Thomas Kajiya}{1951}{}%
  {Informatiker}%
  {person_Kajiya}{Derrick Coetzee}%
  {\urlpers{https://de.wikipedia.org/wiki/Datei:Jim_Kajiya.jpg}}%
  {\cczero}%
  \vspace*{-15mm}

  \begin{align*}
    &\text{Radiance von $x$ in Richtung $Θ$ ausgesendet } \\
    &= \text{emittierte Radiance } + \text{ reflektierte Radiance (aus
      allen Richtungen $Ψ$ der Halbkugel $Ω$)}
  \end{align*}
  
  \[ L(x → Θ) = Lₑ(x → Θ) + ∫_Ω f(x, Θ ↔ Ψ) · L(x ← Ψ) · \rk{Nᵀ · Ψ} \, \dd ω \]
  
  \begin{tabular}{Ll}
    L(x → Θ) & Radiance ausgehend von $x$ in Richtung $Θ$ \\
    Lₑ(x → Θ) & von $x$ in Richtung $Θ$ emittierte Radiance \\
    f(x, Θ ↔ Ψ) & BRDF \\
    L(x ← Ψ) & Radiance aus Richtung $Ψ$ \\
    N & Normale
  \end{tabular}
  
  BRDF: beschreibt Reflexions- und
  Absorptionseigenschaften des Materials (siehe \ref{subsec:BRDF})
\end{description}

\pagebreak

Die Radiance ist entlang gerader Linien (Strahlen) konstant (zumindest
im Vakuum).

Ist von einem Punkt $x$ in Richtung $Ψ$ der Punkt $x'$ sichtbar, dann gilt:

\[ \text{Radiance, die $x$ aus Richtung $Ψ$ empfängt }
  = \text{ Radiance, die $x'$ in Richtung $-Ψ$ aussendet} \]
also
\[ L\fk{x ← Ψ} = L\fk{x' → -Ψ} \]

\pagebreak

\minisec{Formulierung mit Flächenstücken}

Erinnerung an Bemerkung~\ref{bem:verkuerzteFlaeche}:
$\dd ω = \frac{\cos φ}{r²} \dd A = \frac{{N'}ᵀ·-Ψ}{\norm{x-x'}²} \dd A$

Integriere über alle von $x$ sichtbaren Flächenstücke $A'$:

\[ L(x → Θ) = Lₑ(x → Θ) + ∫_{A'} f(x, Θ ↔ Ψ) · L\fk{x' → -Ψ} · G\fk{x, x'} · V\fk{x, x'} \, \dd A'  \]
mit
\begin{align*}
  G\fk{x, x'} &= \frac{\rk{Nᵀ · Ψ} · \rk{{N'}ᵀ · -Ψ}}{\norm{x-x'}²} \\
  V\fk{x, x'} &= \begin{cases}
    1 & \text{ falls $x'$ von $x$ aus sichtbar ist} \\
    0 & \text{ sonst}
  \end{cases}
\end{align*}

\pagebreak

\begin{bemerkung}
  mit obiger Formulierung nicht modellierbar:
  \begin{itemize}
  \item Abhängigkeit von der Wellenlänge: Farbenzerstreuung
    (Dispersion) durch Prismen, chromatische Aberration \oae kann
    durch Sampling des Spektrums simuliert werden
    (\vgl \ref{sec:faerbungSampling}).
  \item Effekte der Wellenoptik wie Beugung (Diffraktion),
    Interferenz, Polarisation

    (Dünnfilm-Interferenz kann innerhalb der BRDF simuliert werden.)
  \item Transluzenz (partiell lichtdurchlässige Medien), Approximation
    für Volumenstreuung (subsurface scattering) möglich oder
    Ausweitung auf Integration entlang des gesamten Pfades (full path
    integration) und Volumengrafik (volumetric rendering)
  \end{itemize}
\end{bemerkung}
\Reached{WS18/19}{12}{2019/01/17}

\pagebreak


\subsection{Zusammenhang zwischen Rendergleichung und Radiosity}

\begin{description}
\item[Radiosity:] gesamte von einem Punkt $x$ aus in
  \emph{alle Richtungen} abgestrahlte Leistung
\item[Annahme 1:] $L(x → Θ) = L(x)$ ist für alle Richtungen konstant
  (vollkommen diffuse Abstrahlung)
  \begin{align*}
    ⇒ \quad B(x) &= ∫_Ω L(x → Θ) · \rk{Nᵀ · Θ} \, \dd ω \\
    &= L(x) · ∫_Ω \rk{Nᵀ · Θ} \, \dd ω \\
    &= π L(x) \qquad \text{(\vgl Gleichung~\eqref{eq:radiosityEdA})}
  \end{align*}

  Formulierung der Rendergleichung mit Flächenstücken – multipliziert
  mit $π$ – gibt:
  \[ B(x) = Eₑ(x) + ∫_{A'} f(x, Θ ↔ Ψ) · B\fk{x'} · G\fk{x, x'} · V\fk{x, x'} \, \dd A'  \]

\item[Annahme 2:] $f(x, Θ ↔ Ψ) = \frac{ρ}{π}$ konstant (vollkommen
  diffuse Abstrahlung)
  \[ ⇒ \quad B(x) = Eₑ(x) + \frac{ρ}{π} · ∫_{A'} B\fk{x'} · G\fk{x, x'} · V\fk{x, x'} \, \dd A'  \]

  Auf\/teilung in Patches ($A' = ⋃ⱼ₌₁ⁿ A_j$) und Aufsummierung der
  Radiosities gibt:
  \[ B(x) = Eₑ(x) + \frac{ρ}{π} · ∑ⱼ₌₁ⁿ ∫_{Aⱼ} B\fk{xⱼ} · G\fk{x, xⱼ} · V\fk{x, xⱼ} \, \dd Aⱼ  \]

\item[Annahme 3:] Radiosity innerhalb der Patches konstant; verwende
  Mittelwert über die Fläche:
  \[ Bᵢ = \frac{1}{Aᵢ} · ∫_{Aᵢ} B\fk{xᵢ} \, \dd xᵢ \]
  Einsetzen ergibt:
  \begin{align*}
    Bᵢ &=
    Eᵢ + \frac{1}{Aᵢ} · ∫_{Aᵢ} \frac{ρᵢ}{π} · ∑ⱼ₌₁ⁿ Bⱼ · ∫_{Aⱼ} G\fk{xᵢ, xⱼ} · V\fk{xᵢ, xⱼ} \, \dd Aⱼ \, \dd Aᵢ \\
    &= Eᵢ + ρᵢ · \frac{1}{Aᵢ} · ∑ⱼ₌₁ⁿ Bⱼ
    · ∫_{Aᵢ}∫_{Aⱼ} \frac{G\fk{xᵢ, xⱼ}}{π} · V\fk{xᵢ, xⱼ} \, \dd Aⱼ \, \dd Aᵢ \\
    &= Eᵢ + ρᵢ · \frac{1}{Aᵢ} · ∑ⱼ₌₁ⁿ Bⱼ
    · ∫_{Aᵢ}∫_{Aⱼ} \frac{\rk{Nᵢᵀ · Ψ} · \rk{Nⱼᵀ · - Ψ}}{π \norm{xᵢ - xⱼ}²} Hⱼᵢ \, \dd Aⱼ \, \dd Aᵢ \\
    &= Eᵢ + ρᵢ · \frac{1}{Aᵢ} · ∑ⱼ₌₁ⁿ Bⱼ · ∫_{Aᵢ}∫_{Aⱼ} \frac{\cos φᵢ · \cos φⱼ}{π rᵢⱼ²} Hⱼᵢ \, \dd Aⱼ \, \dd Aᵢ
  \end{align*}
\end{description}
Das ist exakt Gleichung~\eqref{eq:radiosityFormfaktorIntegral}
eingesetzt in Gleichung~\eqref{eq:radiosityDiskret}, dividiert durch $Aᵢ$.

\begin{description}
\item[\emph{also:}] Die Radiositygleichung ist ein Spezialfall der Rendergleichung.
\end{description}


\subsection{Monte-Carlo-Integration}%
\index{Monte-Carlo-Integration}

\begin{description}
\item[Frage:] Wie berechnet man
  \[ I = ∫_Ω g(x) \, \dd x \, \text? \]

\item[Idee:] Wähle $n$ zufällige Richtungen, gleichmäßig verteilt über
  die Einheitshalbkugel $Ω$.
  \[ I ≈ ∫_Ω \, \dd x · \frac1n ∑ᵢ₌₁ⁿ g\fk{xᵢ} = \frac{2π}{n} ∑ᵢ₌₁ⁿ g\fk{xᵢ} \]
\end{description}

Aus der Rendergleichung wird dann:
\[ Lₒᵤₜ ≈ Lₑ + \frac{2π}{n} ∑ᵢ₌₁ⁿ \rk{fᵢ · Lᵢ · \rk{Nᵀ · Ψᵢ}} \]

\begin{description}
\item[Konvergenz:] Standardabweichung $σ$ hat Konvergenzordnung $𝒪\fk{\frac{1}{\sqrt{n}}}$
  % Bei unabhängigen und identisch verteilten Samples
  % gilt für die Standardabweichung:
  % \[ σ\mk{\frac{c}{n}∑ᵢ₌₁ⁿ g\fk{xᵢ}} = \frac{c}{\sqrt{n}} σ\mk{g(x)} \]
\end{description}

\pagebreak


\subsection{Erweiterungen des Raytracing-Modells}

Erweiterung des Whitted-Ansatzes zu
\emph{diffusem Raytracing (stochastisches Raytracing, \\
  distributed ray tracing)}%
\index{diffuses Raytracing}\index{stochastisches Raytracing}\index{Raytracing!diffuses}
(Cook/Porter/Carpenter 1984)
\person{19mm}{Robert L.~Cook}{1952, Knoxville, Tennessee}{}{Computergraphiker, Pixar}%
{person_Cook}{U.S.~General Services Administration}%
{\urlpers{https://commons.wikimedia.org/wiki/File:Rob_Cook.png}}{}%pd

\personHidden{4mm}{Thomas K.~Porter}{}{}{Computergraphiker, Pixar}{person_Porter}{}%
{\urlpers{http://www.fenn.org/page.cfm?p=574&newsid=225}}{}%

\personHidden{-11mm}{Loren C.~Carpenter}{1947, Brighton, Michigan}{}%
{Computergraphiker, Pixar}%
{person_Carpenter}{}%
{\urlpers{http://memory-alpha.wikia.com/wiki/Loren_Carpenter}}{}%
\vspace*{-19mm}

\begin{description}
\item[Idee:] verfolge mehrere zufällig ausgewählte Strahlen
\item[ermöglicht:] \mbox{}
  \begin{itemize}
  \item weiche Schatten (durch mehrere Strahlen zu ausgedehnten
    Lichtquellen)
  \item Tiefenunschärfe (Wahl mehrerer Punkte in Blendenöffnung des
    virtuellen Kamerasystems)
  \item verschwommene Reflexion bei glänzenden Oberflächen (mehrere
    Reflexionsstrahlen)
  \item Lichtdurchlässsigkeit (Transluzenz) (mehrere
    Brechungsstrahlen)
  \item Bewegungsunschärfe (zeitliche Verteilung der Strahlen)
  \end{itemize}
  \begin{center}
    \input{fig_renderDistributedRayPath}
  \end{center}
  % \XXX ?: Grafik raytree?

  \pagebreak

\item[aber:]  \mbox{}
  \begin{itemize}
  \item nach wie vor nur Strahlen zu Lichtquellen, für Reflexion und
    Brechung
  \item keine Berücksichtigung indirekter Beleuchtung (diffuse
    Reflexion) – außer ambientem Anteil
  \item löst nicht die Rendergleichung
  \item Aufwand durch starke Verzweigung der Strahlen
  \end{itemize}
\item[Umsetzung:] keine Strahlvervielfachung an jedem Objekt,
  sondern mehrere Strahlen pro Bildpunkt (wie für Antialiasing) – danach Verzweigung wie bei
  Standard-Raytracing mit zufälligen Richtungen
\end{description}
% \imagelinkadd{Grafiken/raytree}
\vspace*{-14mm}

\pagebreak

\pngpage{Bilder/yagir/cornell-distrt-pointlight}

\pngpage{Bilder/yagir/cornell-distrt-arealight}

\pngpage{Bilder/yagir/cornell-distrt-pointlight-depthoffield}

\pngpage{Bilder/yagir/cornell-distrt-arealight-depthoffield}

% \imagelink{Bilder/cornell_dl_pl}
% \imagelinkadd{Bilder/cornell_dl_al}
% \imagelinkadd{Bilder/cornell_dl_pl_dof}
% \imagelinkadd{Bilder/cornell_dl_al_dof}

\pagebreak


\subsection{Path Tracing}%
\index{Path Tracing}

\begin{description}
\item[Idee:] (nach Kajiya, 1986)
  \begin{itemize}
  \item für jeden Bildpunkt mehrere Strahlen
  \item Verfolgung eines einzelnen Strahls, \dH im Gegensatz zu
    Raytracing keine Aufspaltung in reflektierten oder gebrochenen
    Strahl
  \item Reflexion oder Brechung wird zufällig entschieden
    (einschließlich diffuser Reflexion)
  \item zufällige Wahl der Richtung anhand BRDF, dadurch einheitliche
    Behandlung von indirekter Beleuchtung, Spiegelung, Brechung
  \item bei Treffen eines Objekts Lichtbeitrag aus einer zufällig
    ausgewählten Lichtquelle

    (auch möglich ohne Strahlverfolgung zu Lichtquellen, aber dann
    langsame Konvergenz durch zufälliges Treffen der Lichtquellen)
  \end{itemize}
\end{description}

\begin{itemize}
\item[\Good] Lösung der Rendergleichung
\item[\Bad] benötigt viele Strahlen (langsam), sonst Bildrauschen
\end{itemize}

\pagebreak

\pngpage{Bilder/yagir/cornell-pt}

\pagebreak

\Reached{WS17/18}{13}{2018/01/18}% eigtl. hinter pngpage

\vspace*{-20mm}
\subsection{BRDF}%
\label{subsec:BRDF}

\begin{description}
\item[BRDF\index{BRDF}:] bidirektionale Reflektanzverteilungsfunktion (bidirectional
  reflectance distribution function): beschreibt Reflexions- und
  Absorptionseigenschaften des Materials
\item[formale Definition:]
  \[ f(x, Θ ↔ Ψ) = \frac{\dd L(x → Θ)}{L(x ← Ψ) \rk{Nᵀ · Ψ} \dd ω} \quad
    \ek{\frac{1}{\text{sr}}} \]
  % \imagelink{Grafiken/brdf}
  % \imagelinkadd{Grafiken/brdfs4}
  % \imagelinkadd{Grafiken/brdfs5}
  \begin{center}
    \input{fig_renderBRDF1}%ΨΘ
  \end{center}
\item[anschauliche Bedeutung:] Verhältnis zwischen in Richtung $Θ$
  ausgestrahltem und aus Richtung $Ψ$ empfangenen Licht im Punkt $x$

  (eigentlich Quotient aus Strahlungsdichte und Bestrahlungsstärke)

  \pagebreak
  
  \begin{center}
    \input{fig_renderBRDF2}%θ
  \end{center}
\item[notwendige Eigenschaften] für physikalische Korrektheit:
  \begin{itemize}
  \item $f(x, Θ ↔ Ψ) ≥ 0$ \quad (Positivität)
  \item $f(x, Θ ↔ Ψ) = f(x, Ψ ↔ Θ)$ \quad (Helmholtz-Reziprozität)
  \item $∫_Ω f(x, Θ ↔ Ψ) \rk{Nᵀ · Ψ} \dd ω ≤ 1$ für alle $Θ$ \quad (Energieerhaltung)
  \end{itemize}

  \pagebreak
  
\item[BTDF\index{BTDF}:] bidirectional transmittance distribution function, analog
  für lichtdurchlässige Materialien für Bereich unter Oberfläche
  % \imagelink{Grafiken/btdfs}
  \begin{center}
    \input{fig_renderBTDF}
  \end{center}
\item[BSDF\index{BSDF}:] bidirectional scattering distribution function (BRDF +
  BTDF zusammen)
  % \imagelink{Grafiken/complex-bsdf}
  \begin{center}
    \input{fig_renderBSDF}
  \end{center}
\end{description}
\Reached{WS19/20}{13}{2020/01/16}

\pagebreak

\minisec{BRDF: Beispiele}

% \imagelink{Bilder/diffuse}
% \imagelinkadd{Bilder/phong1}
% \imagelinkadd{Bilder/phong2}
% \imagelinkadd{Bilder/phong3}
% \imagelinkadd{Bilder/phong4}
% \imagelinkadd{Bilder/phong5}
% \imagelinkadd{Bilder/phong6}

\begin{description}
\item[diffus (Lambert):] \mbox{}
  \[ f = \frac{R_d}{π} \]
\item[Spiegelung:] \mbox{}
  \[ f = Rₛ · \frac{δ\fk{Ψ - S(Θ, N)}}{Nᵀ · Ψ} \]
  ($δ(0) = 1$, $δ(w) = 0$ für $w ≠ 0$, $S(Θ, N)$: Spiegelrichtung)

  Damit folgt:
  \[ ∫_Ω Rₛ · \frac{δ\fk{Ψ - S(Θ, N)}}{Nᵀ · Ψ} · L(x ← Ψ) · \rk{Nᵀ · Ψ} \, \dd ω
    = Rₛ · L(x ← S(Θ, N)) \]
\item[winkelabhängige Reflexion (Phong):] \mbox{}
  \[ f = R_w · \frac{ν + 2}{2π} · \frac{\rk{S(Ψ, N)ᵀ · Θ}^ν}{Nᵀ · Ψ} \]
\end{description}

\pagebreak

\pngpage{Bilder/yagir/diffuse}
\pngpage[\imglic{}{Martin Galgon, light probe: Bernhard Vogl, \urllic{http://dativ.at/lightprobes/}}%
{}{}]{Bilder/yagir/phong1}
\pngpage[\imglic{}{Martin Galgon, light probe: Bernhard Vogl, \urllic{http://dativ.at/lightprobes/}}%
{}{}]{Bilder/yagir/phong2}
\pngpage[\imglic{}{Martin Galgon, light probe: Bernhard Vogl, \urllic{http://dativ.at/lightprobes/}}%
{}{}]{Bilder/yagir/phong3}
\pngpage[\imglic{}{Martin Galgon, light probe: Bernhard Vogl, \urllic{http://dativ.at/lightprobes/}}%
{}{}]{Bilder/yagir/phong4}
\pngpage[\imglic{}{Martin Galgon, light probe: Bernhard Vogl, \urllic{http://dativ.at/lightprobes/}}%
{}{}]{Bilder/yagir/phong5}
\pngpage[\imglic{}{Martin Galgon, light probe: Bernhard Vogl, \urllic{http://dativ.at/lightprobes/}}%
{}{}]{Bilder/yagir/phong6}

\pagebreak


\subsection{Kombination von BRDFs}

\zB für Glas, glänzende Oberflächen, …
% \imagelink{Bilder/diffuse_mirror}
% \imagelinkadd{Bilder/blue_glass}
% \imagelinkadd{Bilder/plastic_bunny}
% \imagelinkadd{Bilder/art}

\begin{description}
\item[Beobachtung:] Der Anteil gebrochenen und reflektierten Lichts
  hängt vom Winkel ab.

  Beispiel: Wasseroberflächen spiegeln stärker, wenn man aus flachem
  Winkel darauf schaut.

  Berechnung durch fresnelsche Formeln aus parallel und senkrecht zur
  Einfallsebene polarisiertem Licht.
  \ReachedZoom{WS20/21}{12}{2021/01/28}
\item[Verwendung in Path Tracing:] Reflexionsgrad als
  Wahrscheinlichkeit bei der Auswahl zwischen mehreren BRDFs.
\item[komplexere Materialen:] modellierbar durch Schichten von BRDFs
  und Lichttransport dazwischen
  % \imagelink{Grafiken/diffuse-and-reflection}
\end{description}

\begin{center}
  {\small\input{fig_renderCombBRDF}}
\end{center}

\pagebreak

\pngpage[\imglic{}{Martin Galgon, light probe: Bernhard Vogl, \urllic{http://dativ.at/lightprobes/}}%
{}{}]{Bilder/yagir/diffuse-and-mirror}

\pngpage[\imglic{}{Martin Galgon, light probe: Bernhard Vogl, \urllic{http://dativ.at/lightprobes/}}%
{}{}]{Bilder/yagir/blue-glass}

\pngpage[\imglic{}%
{Martin Galgon, Modell: Stanford University Computer Graphics Laboratory, %
  \urllic{http://graphics.stanford.edu/data/3Dscanrep/\#bunny}}%
{}{}]{Bilder/yagir/plastic-bunny}

\pngpage[\imglic{}{Martin Galgon, light probe: Bernhard Vogl, \urllic{http://dativ.at/lightprobes/}}%
{}{}]{Bilder/yagir/art-glass-cuboids}

\pagebreak

\Reached{WS21/22}{12}{2022/01/13}


\subsection{Importance Sampling}%
\index{Importance Sampling}

\[ I ≈ \frac1n ∑ᵢ₌₁ⁿ \frac{g\fk{xᵢ}}{p\fk{xᵢ}} \]

Rendergleichung wird zu:
\[ Lₒᵤₜ ≈ Lₑ + \frac{1}{n} ∑ᵢ₌₁ⁿ \rk{\frac{fᵢ}{pᵢ} · Lᵢ · \rk{Nᵀ · Ψᵢ}} \]
% \imagelink{Bilder/conv_pt_100spp_uniform}
% \imagelinkadd{Bilder/conv_pt_100spp}
% \imagelinkadd{Bilder/samp_uniform_64spp}
% \imagelinkadd{Bilder/samp_importance_64spp}

Beispiel:
\[ p(Ψ) = \frac{Nᵀ · Ψ}{π} \]

\pagebreak

\pngpage{Bilder/yagir/cornell-pt-uniform-100spp}
% Reines Path Tracing, gleichmäßige Verteilung der Richtungen. 100 Pfade pro Pixel.

\pngpage{Bilder/yagir/cornell-pt-impsampcostheta-100spp}
% Reines Path Tracing, Verteilung der Richtungen proportional zu cos(theta). 100 Pfade pro Pixel.

\pngpage{Bilder/yagir/cornell-microfacet-uniform-64spp}
% Gleichverteilte Abtastung für Microfacetten nach Phong.

\pngpage{Bilder/yagir/cornell-microfacet-impsamp-64spp}
% Importance Sampling für Microfacetten nach Phong.

% \XXX Zufallszahlen, PDF (Wahrscheinlichkeitsdichtefunktion, probability distribution function),
% CDF (Verteilungsfunktion, cumulative distribution function)

\pagebreak


\subsection{Direkte Beleuchtung}

\begin{description}
\item[Idee:] Bei Punkten in der Szene, bei denen klar ist, dass Sie
  direkt von einer Lichtquelle getroffen werden, soll diese nicht
  zufällig gefunden werden müssen.

  
\item[⇒] Auf\/teilung des Monte-Carlo-Prozesses in zwei Teile
  (direct lighting, next event estimation)
\end{description}

\begin{align*}
  L(x → Θ) &= Lₑ + ∫_Ω f · L(x ← Ψ) · \rk{Nᵀ · Ψ} \, \dd ω \\
  &= Lₑ + ∫_{\widehat{Ω}} f · Lₑ\fk{x' → -Ψ} · \rk{Nᵀ · Ψ} \, \dd ω
  + ∫_{Ω∖\widehat{Ω}} f · L(x ← Ψ) · \rk{Nᵀ · Ψ} \, \dd ω
\end{align*}
% \imagelink{Bilder/conv_pt_10spp_uniform}
% \imagelinkadd{Bilder/conv_dlpt_10spp}
% \imagelinkadd{Bilder/conv_pt_100spp}%vgl. oben
% \imagelinkadd{Bilder/conv_dlpt_100spp}
 
also indirekter Anteil ohne Emission

\pagebreak

\pngpage{Bilder/yagir/cornell-pt-uniform-10spp}

\pngpage{Bilder/yagir/cornell-pt-directlighting-10spp}

\pngpage{Bilder/yagir/cornell-pt-impsampcostheta-100spp}

\pngpage{Bilder/yagir/cornell-pt-directlighting-100spp}

\pagebreak


\subsection{Multiple Importance Sampling}%
\index{Multiple Importance Sampling}

(nach Veach, 1997)
\personHidden{0mm}{Eric Veach}{}{}%
{Informatiker}%
{person_Veach}{}%
{\urlpers{https://www.rainforesttrust.org/about-us/our-team/}}{}%
% \imagelink{Grafiken/mis}
% \imagelinkadd{Bilder/mis_dl_light_64spp}
% \imagelinkadd{Bilder/mis_dl_brdf_64spp}
% \imagelinkadd{Bilder/mis_200spp}

\begin{description}
\item[Beobachtung 1:] Wahl der Richtungen für direkte Beleuchtung durch Abtasten der
  Lichtquellen gut bei diffusem Material und kleinem Raumwinkel zur Lichtquelle
\item[Beobachtung 2:] Wahl der Richtungen für direkte Beleuchtung
  durch BRDF gut bei glänzendem Material und großem Raumwinkel zur
  Lichtquelle
  \begin{center}
    \input{fig_renderMIS}
  \end{center}
\item[Idee:] kombiniere beides
\item[Frage:] Wie lassen sich beide berechneten Ergebnisse
  kombinieren?

  \pagebreak

\item[Multi-Sample-Modell:] \mbox{}
  \[ I ≈ ∑ᵢ₌₁ⁿ \frac{1}{nᵢ} ∑ⱼ₌₁^{nᵢ} wᵢ\fk{x_{i,j}} \frac{f\fk{x_{i,j}}}{pᵢ\fk{x_{i,j}}} \]
  \begin{tabular}{Ll}
    n & Anzahl verschiedener Sampling-Strategien $pᵢ$ \\
    nᵢ & Anzahl der Samples für Strategie $i$ \\
    wᵢ & Gewichtsfunktion für Samples der Strategie $i$
  \end{tabular}
  
  Wahl der $wᵢ$ \zB per Balance-Heuristik:
  \[ wᵢ(x) = \frac{nᵢ pᵢ(x)}{∑ₖ nₖ pₖ(x)} \]

\item[Single-Sample-Modell:] Wähle Strategie $pᵢ$ mit
  Wahrscheinlichkeit $cᵢ$.
  \[ I ≈ \frac{wᵢ\fk{xᵢ} f\fk{xᵢ}}{cᵢ pᵢ\fk{xᵢ}} \]
\end{description}

\pagebreak

\pngpage{Bilder/yagir/mis-dl-light-64spp}

\pngpage{Bilder/yagir/mis-dl-brdf-64spp}

\pngpage{Bilder/yagir/mis-dl-light-and-brdf-200spp}

\pagebreak


\vspace*{-26mm}
\subsection{Weiterentwicklungen}

\minisec{Bidirektionales Path Tracing}%
\index{bidirektionales Path Tracing}\index{Path Tracing!bidirektionales}

(Lafortune/Willems 1993, Veach/Guibas 1994)
\personHidden{16mm}{Eric P.~F.~Lafortune}{}{}%
{Informatiker}%
{person_Lafortune}{}%
{\urlpers{http://www.lafortune.eu/}}{}%

\personHidden{1mm}{Yves D.~Willems}{}{}%
{Informatiker}%
{person_Willems}{}%
{\urlpers{https://github.com/yveswillems}}{}%
% {\urlpers{https://www.kuleuven.be/wieiswie/en/person/00009298}}{}% % alt

\person{-14mm}{Leonidas John Guibas (Λεωνίδας Ιωάννης Γκίμπας [Leōnídas Iōánnēs Gkímpas])}%
{1949}{}%
{Informatiker}%
{person_Guibas}{Sergio01}%
{\urlpers{https://commons.wikimedia.org/wiki/File:Leonidas_Guibas_2010_06_29.png}}%
{\ccbysa~3.0, \urllic{https://creativecommons.org/licenses/by-sa/3.0/legalcode}}%
\vspace*{-19mm}

\begin{itemize}
\item Konstruiere jeweils zwei Pfade jeweils fester Länge:
  %\imagelink{Grafiken/bidir-pt}
  \begin{itemize}
  \item einen ausgehend vom Kamerapunkt
  \item einen ausgehend von einer Lichtquelle
  \end{itemize}
\item Verbinde Zwischenpunkte der Pfade zu vollständigen Pfaden
  Lichtquelle – Kamerapunkt
\item[\Good] bessere Darstellung von Kaustiken (durch Lichtbündelung
  entstehende helle Bereiche)
  \begin{center}
    \input{fig_renderBidiPT}

    hier: gewichteter Mittelwert der Strahlen $\rk{x₀, x₁, y₀}$,
    $\rk{x₀, x₁, x₂, y₀}$ (Anteil $0$ wegen Verdeckung),
    $\rk{x₀, x₁, y₁, y₀}$, $\rk{x₀, x₁, x₂, y₁, y₀}$, $\rk{x₀, x₁, y₂, y₁, y₀}$, $\rk{x₀, x₁, x₂, y₂, y₁, y₀}$
  \end{center}
\end{itemize}

\pagebreak

\pngpageHidden[\imglic{}%
{\urllic{http://www.edxgraphics.com/uploads/8/5/2/1/8521459/7180718_orig.jpg}}%
{}{}]{Bilder/web/bunny-bidipt-caustics}

\pngpage[\imglic{Alan Leigh-Lancaster}%
{\urllic{https://commons.wikimedia.org/wiki/File:Computer_Generated_Caustics.png}}%
{„Computer Generated Caustics“}%
{\ccbysa~3.0, \urllic{https://creativecommons.org/licenses/by-sa/3.0/legalcode}%
}]{Bilder/wikimedia/glass-bidipt-caustics}

\pagebreak

\minisec{Metropolis Light Transport}%
\index{Metropolis Light Transport}

(Veach/Guibas 1997)
\begin{itemize}
\item Erweiterung des bidirektionalen Path Tracings
\item Ist ein „guter“ Pfad gefunden worden (hoher Beitrag zum Bild),
  betrachte zusätzliche Pfade, die sich durch kleine Änderungen ergeben.
  \begin{itemize}
  \item Hinzufügen eines zusätzlichen Punktes zum Pfad
  \item kleine Verschiebungen der Knotenpunkte des Pfads
    %\imagelink{Bilder/mlt-bpt}
  \end{itemize}
\end{itemize}

\Reached{WS16/17}{14}{2017/02/02}

\pagebreak

\pngpageHidden[\imglic{Eric Veach, Leonidas John Guibas}%
{\urllic{https://graphics.stanford.edu/papers/metro/}}%
{}{}]{Bilder/web/mlt-vs-bidipt-magnified}

\pagebreak

\minisec{Photon Mapping}%
\index{Photon Mapping}

(Jensen 1995)
\personHidden{-14mm}{Henrik Wann Jensen}%
{1969, Harlev, DK}{}%
{Computergraphiker}%
{person_Jensen}{}%
{\urlpers{http://graphics.ucsd.edu/~henrik/}}%
{}%

\begin{itemize}
\item zweistufiges Verfahren
\item 1.~Schritt: Aussenden von Lichtpaketen („Photonen“) von den
  Lichtquellen, Speicherung des Ergebnisses in einer Photon Map
  (unabhängig vom Betrachtungspunkt)

  für Kaustiken zusätzliche Speicherung einer „Caustic Map“
\item 2.~Schritt: Rendern \zB durch Kombination von diffusem
  Raytracing für direkte Beleuchtung und Information aus Photon Map
  für indirekte Beleuchtung

  auch in Verbindung mit Path Tracing zur Beschleunigung
  
\item Verfahren ist „biased“ (keine Konvergenz gegen Lösung der
  Rendergleichgung durch Mittelwert vieler gerenderter Bilder) aber
  Konvergenz mit zunehmender Anzahl an Photonen
\end{itemize}

\pagebreak

\pngpage[\imglic{Purpy Pupple}%
{\urllic{https://commons.wikimedia.org/wiki/File:Glass_ochem.png}}%
{„Glass ochem“}%
{\ccbysa~3.0, \urllic{https://creativecommons.org/licenses/by-sa/3.0/legalcode}%
}]{Bilder/wikimedia/glass-molecule-photonmapping}

\pngpage[\imglic{Tobias R Metoc}%
{\urllic{https://commons.wikimedia.org/wiki/File:Glas-2000-enery.jpg}}%
{„Glas-2000-enery“}%
{\ccbysa~2.5, \urllic{https://creativecommons.org/licenses/by-sa/2.5/legalcode}%
}]{Bilder/wikimedia/glass-en2000-photonmapping}

\mbox{}
\Reached{WS17/18}{14}{2018/01/25}
\Reached{WS18/19}{13}{2019/01/24}
\Reached{WS19/20}{14}{2020/01/23}
\ReachedZoom{WS20/21}{13}{2021/02/04}
\Reached{WS21/22}{13}{2022/01/20}
